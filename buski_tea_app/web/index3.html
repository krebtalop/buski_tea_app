<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buski Çay Ocağı Yönetim Paneli</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    :root {
      --primary-color: #2563eb;
      --secondary-color: #16a34a;
      --warning-color: #f59e0b;
      --danger-color: #dc2626;
      --error-color: #9d17d2; /* Mor renk */
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    .header-gradient {
  background: linear-gradient(90deg, #ff0000 0%, #b30000 100%);
    }


    .tab-active {
      font-weight: 700;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      border-radius: 8px 8px 0 0;
    }
    
    /* Hazırlananlar sekmesi aktif durumu - mavi */
    #preparing-tab.tab-active {
      background-color: #dbeafe !important;
      color: #1d4ed8 !important;
      border-bottom-color: #3b82f6 !important;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2) !important;
    }
    
    /* Teslim edilenler sekmesi aktif durumu - yeşil */
    #delivered-tab.tab-active {
      background-color: #dcfce7 !important;
      color: #15803d !important;
      border-bottom-color: #16a34a !important;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.2) !important;
    }
    
    /* Puanlama sekmesi aktif durumu - sarı */
    #ratings-tab.tab-active {
      background-color: #fef3c7 !important;
      color: #d97706 !important;
      border-bottom-color: #f59e0b !important;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2) !important;
    }
    
    .tab-inactive {
      color: #6b7280;
      border-bottom-color: transparent;
      background-color: transparent;
      transition: all 0.3s ease;
      border-radius: 8px 8px 0 0;
    }
    .tab-inactive:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Hazırlananlar sekmesi hover - mavi */
    #preparing-tab:hover {
      background-color: #dbeafe !important;
      color: #1d4ed8 !important;
      border-bottom-color: #3b82f6 !important;
    }
    
    /* Teslim edilenler sekmesi hover - yeşil */
    #delivered-tab:hover {
      background-color: #dcfce7 !important;
      color: #15803d !important;
      border-bottom-color: #16a34a !important;
    }
    
    /* Puanlama sekmesi hover - sarı */
    #ratings-tab:hover {
      background-color: #fef3c7 !important;
      color: #d97706 !important;
      border-bottom-color: #f59e0b !important;
    }
    
    /* Aktif sekme hover stilleri - hover'da da aktif kalması için */
    #preparing-tab.tab-active:hover {
      background-color: #dbeafe !important;
      color: #1d4ed8 !important;
      border-bottom-color: #3b82f6 !important;
    }
    
    #delivered-tab.tab-active:hover {
      background-color: #dcfce7 !important;
      color: #15803d !important;
      border-bottom-color: #16a34a !important;
    }
    
    #ratings-tab.tab-active:hover {
      background-color: #fef3c7 !important;
      color: #d97706 !important;
      border-bottom-color: #f59e0b !important;
    }
    .floor-card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .floor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .order-card {
      background: #f8fafc;
      border-radius: 10px;
      border-left: 4px solid #cbd5e1;
      transition: all 0.3s ease;
      overflow: visible;
    }
    .order-card-preparing {
      border-left-color: #FDBA74;
      background-color: #FFF7ED;
    }
    .order-card-delivering, .order-card-delivered {
      border-left-color: #dc2626;
      background-color: #fee2e2;
    }
    .order-card-ready {
      border-left-color: var(--secondary-color);
      background-color: #f0fdf4;
    }
    .status-btn {
      transition: all 0.2s ease;
      font-weight: 500;
      border-radius: 6px;
    }
    .btn-preparing {
      background-color: var(--warning-color);
      color: white;
    }
    .btn-preparing:hover:not(:disabled) {
      background-color: #d97706;
    }
    .btn-ready {
      background-color: var(--secondary-color);
      color: white;
    }
    .btn-ready:hover:not(:disabled) {
      background-color: #15803d;
    }
    .btn-delivered {
      background-color: #94a3b8;
      color: white;
      cursor: not-allowed;
    }
    .btn-delete {
      background-color: var(--danger-color);
      color: white;
    }
    .btn-delete:hover {
      background-color: #b91c1c;
    }
    
    /* Çöp Kutusu İkonu Stilleri */
    .delete-icon-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
      opacity: 0.7;
      padding: 4px;
      margin-left: 8px;
    }
    
    .delete-icon-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .delete-icon-preparing {
      color: #6b7280;
    }
    
    .delete-icon-preparing:hover {
      color: #4b5563;
    }
    
    .delete-icon-delivered {
      color: #dc2626;
    }
    
    .delete-icon-delivered:hover {
      color: #b91c1c;
    }
    
    /* Modal Backdrop Efektleri */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .modal-backdrop-light {
      background: rgba(0, 0, 0, 0.5);
    }
    
    /* Modal açıkken header ve navigation'ı arkaya at */
    .modal-open header,
    .modal-open main {
      z-index: 10;
      position: relative;
    }
    
    /* Modal backdrop'unun z-index'ini artır */
    .modal-backdrop,
    .modal-backdrop-light {
      z-index: 80 !important;
    }
    .btn-error {
      background-color: var(--error-color);
      color: white;
    }
    .btn-error:hover {
      background-color: #7e1bb0;
    }
    .empty-state {
      color: #94a3b8;
    }
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -8px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 10;
    }
    

    
    /* Yeni gelen sipariş kartları için yanıp sönme */
    .new-order-card {
      animation: newOrderBlink 1s infinite;
    }
    
    @keyframes newOrderBlink {
      0%, 50% { 
        background-color: #fef2f2 !important;
        border-color: #ef4444 !important;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.3) !important;
      }
      51%, 100% { 
        background-color: #fee2e2 !important;
        border-color: #dc2626 !important;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.4) !important;
      }
    }
    .floor-group-btn {
      background-color: #e2e8f0;
      color: #475569;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 8px 16px;
      margin: 0 4px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .floor-group-btn:hover {
      background-color: #cbd5e1;
    }
    .floor-group-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .fade-out {
      animation: fadeOut 0.7s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    .center-message {
      text-align: center;
      font-weight: 600;
      color: #065f46;
      margin: 8px 0;
      width: 100%;
    }
    /* Modal stilleri */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      /* max-height: 85vh; */
      /* overflow-y: auto; */
      width: 95%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      overflow: visible;
    }
    
    /* Modal içeriklerindeki tüm scrollbar'ları gizle */
    .modal-content::-webkit-scrollbar {
      width: 0px;
      display: none;
    }
    .modal-content::-webkit-scrollbar-track {
      display: none;
    }
    .modal-content::-webkit-scrollbar-thumb {
      display: none;
    }
    .modal-content::-webkit-scrollbar-thumb:hover {
      display: none;
    }
    .modal-content {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .menu-item {
      border-bottom: 1px solid #e2e8f0;
      padding: 12px 0;
    }
    .menu-item:last-child {
      border-bottom: none;
    }
    .add-product-card {
      background-color: #f1f5f9;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px dashed #cbd5e1;
    }
    .add-product-card:hover {
      background-color: #e2e8f0;
      border-color: #94a3b8;
    }
    .form-input {
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 10px 12px;
      transition: border-color 0.2s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .form-submit-btn {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .form-submit-btn:hover {
      background-color: #1d4ed8;
    }
    .form-delete-btn {
      background-color: var(--danger-color);
      color: white;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .form-delete-btn:hover {
      background-color: #b91c1c;
    }
    .scroll-container {
      max-height: 60vh;
      overflow-y: auto;
    }
    /* Scrollbar stilleri - Kaldırıldı */
    .scroll-container::-webkit-scrollbar {
      width: 0px;
      display: none;
    }
    .scroll-container::-webkit-scrollbar-track {
      display: none;
    }
    .scroll-container::-webkit-scrollbar-thumb {
      display: none;
    }
    .scroll-container::-webkit-scrollbar-thumb:hover {
      display: none;
    }
    /* Firefox için scrollbar gizleme */
    .scroll-container {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    /* Modal içeriklerindeki tüm scrollable elementler için scrollbar gizleme */
    .modal-content *::-webkit-scrollbar {
      width: 0px;
      display: none;
    }
    .modal-content *::-webkit-scrollbar-track {
      display: none;
    }
    .modal-content *::-webkit-scrollbar-thumb {
      display: none;
    }
    .modal-content *::-webkit-scrollbar-thumb:hover {
      display: none;
    }
    .modal-content * {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .floor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .order-list {
      flex-grow: 1;
      overflow-y: visible;
      padding: 0.5rem;
    }
    @media (max-width: 768px) {
      .floor-grid {
        grid-template-columns: 1fr;
      }
      .floor-card {
        min-width: 100%;
      }
      .floor-group-btn {
        margin: 2px;
        padding: 6px 12px;
        font-size: 0.875rem;
      }
    }
    .rating-badge {
      display: inline-flex;
      align-items: center;
      background: #fff7ed;
      color: #f59e0b;
      font-weight: 600;
      border-radius: 6px;
      font-size: 1rem;
      padding: 4px 10px;
      margin-top: 8px;
      margin-bottom: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .rating-stars {
      color: #f59e0b;
      font-size: 1.2rem;
      margin-right: 6px;
    }
    .btn-delivering {
      background-color: #dc2626;
      color: white;
    }
    .btn-delivering:hover:not(:disabled) {
      background-color: #b91c1c;
    }
    .btn-delivering[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
      position: relative;
    }
    .btn-delivering[disabled] .fa-times {
      display: none;
      color: #fff;
    }
    @keyframes bounceOut {
      0% { transform: scale(1) translateY(0); opacity: 1; }
      20% { transform: scale(1.1) translateY(-30px); }
      40% { transform: scale(1) translateY(-15px); }
      60% { transform: scale(1.05) translateY(-5px); }
      80% { transform: scale(0.95) translateY(0); }
      100% { transform: scale(0.3) translateY(-100px); opacity: 0; }
    }
    .bounce-out {
      animation: bounceOut 1s forwards;
    }
    
    /* confirm-modal'ün tamamını en üstte tutacak z-index */
    #confirm-modal {
      z-index: 10000 !important;
    }

    /* confirm-content'in de kendi konteynerinin üzerinde olmasını sağla */
    #confirm-content {
      position: relative;
      z-index: 10001 !important;
    }
    
    /* Modal backdrop stilleri */
    .modal-backdrop-light {
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Menü Modal -->
  <div id="menu-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Menü</h2>
        <button id="close-menu-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <div id="menu-list" class="p-4 scroll-container"></div>
    </div>
  </div>
  <!-- Yeni Ürün Ekle Modal -->
  <div id="add-product-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Yeni Ürün Ekle</h2>
        <button id="close-add-product-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <form id="add-product-form" class="p-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
          <input type="text" name="product-name" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺)</label>
          <input type="number" name="product-price" step="0.01" min="0" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Çay Fişi Sayısı</label>
          <input type="number" name="product-tea-tickets" min="0" value="0" class="form-input w-full" required>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Opsiyonlar (Virgülle ayırın)</label>
          <input type="text" name="product-options" placeholder="Örn: Sade, Şekerli, Limonlu" class="form-input w-full">
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="add-product-instock" name="product-instock" class="mr-2" checked>
            <span class="text-sm font-medium text-gray-700">Stokta mevcut</span>
          </label>
        </div>
        <div class="text-center">
          <button type="submit" class="form-submit-btn px-6 py-2">Ürünü Ekle</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Ürün Düzenle Modal -->
  <div id="edit-product-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Ürünü Düzenle</h2>
        <button id="close-edit-product-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <form id="edit-product-form" class="p-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
          <input type="text" id="edit-product-name" name="edit-product-name" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺)</label>
          <input type="number" id="edit-product-price" name="edit-product-price" step="0.01" min="0" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Çay Fişi Sayısı</label>
          <input type="number" id="edit-product-tea-tickets" name="edit-product-tea-tickets" min="0" value="0" class="form-input w-full" required>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Opsiyonlar (Virgülle ayırın)</label>
          <input type="text" id="edit-product-options" name="edit-product-options" placeholder="Örn: Sade, Şekerli, Limonlu" class="form-input w-full">
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="edit-product-instock" name="edit-product-instock" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Stokta mevcut</span>
          </label>
        </div>
        <div class="flex justify-between">
          <button type="submit" class="form-submit-btn px-6 py-2">Güncelle</button>
          <button type="button" id="delete-product-btn" class="form-delete-btn px-6 py-2">Sil</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Personel Modal -->
  <div id="personel-modal" class="modal-overlay">
    <div class="modal-content" style="max-width:600px;">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Personel Yönetimi</h2>
        <button id="close-personel-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <div class="p-4 pt-0">
        <div class="mb-0">
          <div id="personel-list" class="flex flex-col items-center justify-center text-gray-400 py-0">
            <i class="fas fa-users text-4xl mb-2"></i>
            <div>Henüz personel eklenmemiş</div>
          </div>
        </div>
        <hr class="my-6">
        <div class="mb-2 font-semibold">Yeni Personel Ekle</div>
        <form id="add-personel-form" class="flex flex-wrap gap-2 items-center">
          <input type="text" id="personel-ad" placeholder="Ad" class="form-input flex-1 min-w-[120px]">
          <input type="text" id="personel-soyad" placeholder="Soyad" class="form-input flex-1 min-w-[120px]">
          <input type="text" id="personel-tel" placeholder="Telefon" class="form-input flex-1 min-w-[120px]">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">+ Personel Ekle</button>
        </form>
      </div>
    </div>
  </div>
  <!-- Menü Modal -->
  <div id="menu-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Menü</h2>
        <button id="close-menu-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <div id="menu-list" class="p-4 pt-0 scroll-container"></div>
    </div>
  </div>
  <!-- Rapor Modal -->
  <div id="report-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold text-gray-800">Satış Raporu</h2>
      <button id="close-report-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>
    <div id="report-content" class="p-6">
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Tarih: <span id="report-date"></span></h3>
      </div>
      <div class="space-y-4">
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Günlük Toplam Satış</span>
            <span id="daily-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Haftalık Toplam Satış</span>
            <span id="weekly-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Aylık Toplam Satış</span>
            <span id="monthly-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
      </div>
      <!-- Rapor Sıfırlama Butonu -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <button id="reset-report-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg shadow-sm transition-all duration-300 font-medium">
          <i class="fas fa-trash-alt mr-2"></i>Rapor Verilerini Sıfırla
        </button>
      </div>
    </div>
  </div>
</div>
</div>
</div>

  <!-- Kat Bazlı Satış Raporu Modal -->
  <div id="floor-report-modal" class="modal-overlay">
    <div class="modal-content" style="max-width:1000px;">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Kat Bazlı Satış Raporu</h2>
        <button id="close-floor-report-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Kat 7-8-9-10 Satış Raporu</h3>
          <p class="text-sm text-gray-600">Kat satırlarına tıklayarak detay bilgileri görebilirsiniz</p>
          
          <!-- Kat Raporu Periyot Butonları -->
          <div class="flex gap-2 mt-3">
            <button id="floor-daily-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
              Günlük
            </button>
            <button id="floor-weekly-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
              Haftalık
            </button>
            <button id="floor-monthly-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300">
              Aylık
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="floor-sales-table" class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left border border-gray-300">Kat</th>
                <th class="px-4 py-2 text-left border border-gray-300">Sipariş Sayısı</th>
                <th class="px-4 py-2 text-left border border-gray-300">Toplam Satış</th>
                <th class="px-4 py-2 text-left border border-gray-300">Detay</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b">
                <td class="px-4 py-2 border border-gray-300 text-center text-gray-500" colspan="4">Veri yükleniyor...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Kat Detay Modal -->
        <div id="floor-detail-modal" class="fixed inset-0 z-[999999] flex items-center justify-center modal-backdrop-light hidden">
          <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="floor-detail-content">
            <div class="p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 id="floor-detail-title" class="text-xl font-bold text-gray-800">Kat Detay Raporu</h3>
                <button id="close-floor-detail-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
              </div>
              <div id="floor-detail-content-body" class="max-h-96 overflow-y-auto">
                <!-- Detay içeriği buraya gelecek -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Kat Raporu Temizleme Butonu -->
        <div class="mt-6 pt-4 border-t border-gray-200">
          <button id="reset-floor-report-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg shadow-sm transition-all duration-300 font-medium">
            <i class="fas fa-trash-alt mr-2"></i>Kat Raporunu Temizle
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Custom Alert Modal -->
  <div id="alert-modal" class="fixed inset-0 z-[90] flex items-center justify-center modal-backdrop-light hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="alert-content">
      <div class="p-6">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0">
            <i id="alert-icon" class="fas fa-info-circle text-blue-500 text-2xl"></i>
          </div>
          <div class="ml-3">
            <h3 id="alert-title" class="text-lg font-medium text-gray-900">Bilgi</h3>
          </div>
        </div>
        <div class="mb-6">
          <p id="alert-message" class="text-sm text-gray-600"></p>
        </div>
        <div class="flex justify-end">
          <button id="alert-ok" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors duration-200">
            Tamam
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Confirm Modal -->
  <div id="confirm-modal" class="fixed inset-0 z-[999999] flex items-center justify-center modal-backdrop-light hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="confirm-content">
      <div class="p-6">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0">
            <i id="confirm-icon" class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
          </div>
          <div class="ml-3">
            <h3 id="confirm-title" class="text-lg font-medium text-gray-900">Onay</h3>
          </div>
        </div>
        <div class="mb-6">
          <p id="confirm-message" class="text-sm text-gray-600"></p>
        </div>
        <div class="flex justify-end space-x-3">
          <button id="confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors duration-200">
            İptal
          </button>
          <button id="confirm-ok" class="px-4 py-2 text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 rounded-md transition-colors duration-200">
            Onayla
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bildirim Sesi -->
      <audio id="order-notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
    <audio id="bell-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" preload="auto"></audio>
    <audio id="notification-sound" src="assets/sounds/notification.mp3" preload="auto"></audio>
  <!-- Ana İçerik -->
  <header class="header-gradient text-white py-6 px-4 shadow-lg relative">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold flex items-center justify-center">
        <i class="fas fa-mug-hot mr-3"></i>
        Buski Çay Ocağı Yönetim Paneli
      </h1>
      <p class="mt-2 opacity-90 text-center">Siparişleri takip edin ve durumlarını güncelleyin</p>
    </div>
    
    <!-- Rapor Butonları (sol üst) -->
    <div class="absolute top-4 left-4 z-50 flex flex-col gap-2">
        <button id="open-report-btn" 
        class="bg-white text-black px-4 py-2 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 font-medium">
        Rapor
      </button>
      
        <button id="open-floor-report-btn" 
        class="bg-white text-black px-4 py-2 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 font-medium">
        Kat Raporu
      </button>
      
      </button>
    </div>
    <!-- Menü ve Personel Butonları (sağ üst) -->
    <div class="absolute top-4 right-4 z-50 flex flex-col items-end gap-2">
        <button id="open-menu-btn" 
        class="bg-white text-black px-6 py-2 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 font-medium w-24 flex items-center justify-center">
Menü
      </button>
      
        </button>
        <button id="open-personel-btn" 
        class="bg-white text-black px-6 py-2 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 font-medium w-24 flex items-center justify-center">
Personel
      </button>
        
      </button>
      <button id="delete-all-orders-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium hidden" style="margin-top: 30px;">
        <i class="fas fa-trash-alt mr-1"></i>Tüm Teslim Edilenleri Sil
      </button>
              <button id="delete-all-ratings-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium hidden" style="margin-top: 30px;">
            <i class="fas fa-trash-alt mr-1"></i>Tüm Değerlendirmeleri Sil
        </button>

    </div>
  </header>
  <main class="container mx-auto px-4 py-6">
        <!-- Sekmeler -->
    <div class="flex justify-center border-b-2 border-gray-300 mb-6 relative">
      <button id="preparing-tab" class="tab-active px-8 py-4 text-lg font-semibold relative border-b-4 border-blue-500 bg-blue-50">
        <!-- Yeni Sipariş Alarmı -->
        <div id="preparing-alert" class="absolute -top-1 -left-1 flex items-center justify-center">
          <div class="w-6 h-6 bg-red-500 rounded-full animate-ping absolute"></div>
          <div class="w-5 h-5 bg-red-600 rounded-full relative flex items-center justify-center">
            <span id="preparing-count" class="text-white text-xs font-bold">0</span>
          </div>
        </div>
        Hazırlananlar
      </button>
      <button id="delivered-tab" class="tab-inactive px-8 py-4 text-lg font-semibold relative border-b-4 border-transparent hover:border-green-300 hover:bg-green-50">
        Teslim Edilenler
      </button>
      <button id="ratings-tab" class="tab-inactive px-8 py-4 text-lg font-semibold relative border-b-4 border-transparent hover:border-yellow-300 hover:bg-yellow-50">
        Değerlendirmeler
      </button>
    </div>
    

    

    
    <!-- Katlar -->
    <div id="floors-container"></div>
    
    <!-- Puanlama Sekmesi İçeriği -->
    <div id="ratings-container" class="hidden">
      <div class="max-w-4xl mx-auto">
        <!-- Ortalama Puan Kartı -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Kat 7-8-9-10<br>Ortalama Değerlendirmesi</h2>
            <div class="flex items-center justify-center mb-4">
              <span id="average-rating" class="text-4xl font-bold text-blue-600 mr-4">0.0</span>
              <div id="average-stars" class="flex">
                <!-- Yıldızlar JavaScript ile doldurulacak -->
              </div>
            </div>
            <p id="total-ratings" class="text-gray-600">0 Değerlendirme</p>
          </div>
        </div>
        

        
        <!-- Puan Listesi -->
        <div id="ratings-list" class="space-y-4">
          <!-- Puanlar JavaScript ile doldurulacak -->
        </div>
      </div>
    </div>
  </main>
  <script type="module">
    // Rapor modal elemanları
const reportModal = document.getElementById('report-modal');
const openReportBtn = document.getElementById('open-report-btn');
const closeReportBtn = document.getElementById('close-report-btn');
const reportDate = document.getElementById('report-date');
const dailyTotal = document.getElementById('daily-total');
const weeklyTotal = document.getElementById('weekly-total');
const monthlyTotal = document.getElementById('monthly-total');

// Custom Alert ve Confirm modal elemanları
const alertModal = document.getElementById('alert-modal');
const alertContent = document.getElementById('alert-content');
const alertIcon = document.getElementById('alert-icon');
const alertTitle = document.getElementById('alert-title');
const alertMessage = document.getElementById('alert-message');
const alertOk = document.getElementById('alert-ok');

const confirmModal = document.getElementById('confirm-modal');
const confirmContent = document.getElementById('confirm-content');
const confirmIcon = document.getElementById('confirm-icon');
const confirmTitle = document.getElementById('confirm-title');
const confirmMessage = document.getElementById('confirm-message');
const confirmOk = document.getElementById('confirm-ok');
const confirmCancel = document.getElementById('confirm-cancel');

// Rapor modal olay dinleyicileri
openReportBtn.addEventListener('click', () => {
  updateReport();
  reportModal.style.display = 'flex';
});
closeReportBtn.addEventListener('click', () => {
  reportModal.style.display = 'none';
});

// Rapor hesaplama fonksiyonları - Panele göre filtrele
function calculateDailyTotal(orders, date) {
  // Önce panele göre siparişleri filtrele
  const filteredOrders = filterOrdersByPanel(orders);
  
  return filteredOrders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate.getFullYear() === date.getFullYear() &&
           orderDate.getMonth() === date.getMonth() &&
           orderDate.getDate() === date.getDate();
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function calculateWeeklyTotal(orders, date) {
  // Önce panele göre siparişleri filtrele
  const filteredOrders = filterOrdersByPanel(orders);
  
  const startOfWeek = new Date(date);
  startOfWeek.setDate(date.getDate() - date.getDay() + 1);
  startOfWeek.setHours(0, 0, 0, 0);

  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  endOfWeek.setHours(23, 59, 59, 999);

  return filteredOrders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate >= startOfWeek && orderDate <= endOfWeek;
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function calculateMonthlyTotal(orders, date) {
  // Önce panele göre siparişleri filtrele
  const filteredOrders = filterOrdersByPanel(orders);
  
  return filteredOrders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate.getFullYear() === date.getFullYear() &&
           orderDate.getMonth() === date.getMonth();
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

// Otomatik sıfırlama için değişkenler
let lastDailyReset = null;
let lastWeeklyReset = null;
let lastMonthlyReset = null;

// Kat raporu için değişkenler
let activeFloorReportPeriod = 'daily'; // 'daily', 'weekly', 'monthly'
let lastFloorDailyReset = null;
let lastFloorWeeklyReset = null;
let lastFloorMonthlyReset = null;

// Otomatik sıfırlama kontrolü
async function checkAutoReset() {
  const now = new Date();
  const raporRef = doc(db, "raporlar", activeFloorGroup);
  const raporDoc = await getDoc(raporRef);
  
  if (raporDoc.exists()) {
    const data = raporDoc.data();
    lastDailyReset = data.lastDailyReset ? data.lastDailyReset.toDate() : null;
    lastWeeklyReset = data.lastWeeklyReset ? data.lastWeeklyReset.toDate() : null;
    lastMonthlyReset = data.lastMonthlyReset ? data.lastMonthlyReset.toDate() : null;
    
    let needsUpdate = false;
    const updateData = {};
    
    // Günlük sıfırlama kontrolü (her gün 00:00)
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    if (!lastDailyReset || lastDailyReset < today) {
      updateData.dailyTotal = 0;
      updateData.lastDailyReset = Timestamp.fromDate(today);
      needsUpdate = true;
      console.log('Günlük rapor sıfırlandı');
    }
    
    // Haftalık sıfırlama kontrolü (her pazartesi 00:00)
    const monday = new Date(now);
    monday.setDate(now.getDate() - now.getDay() + 1); // Pazartesi
    monday.setHours(0, 0, 0, 0);
    if (!lastWeeklyReset || lastWeeklyReset < monday) {
      updateData.weeklyTotal = 0;
      updateData.lastWeeklyReset = Timestamp.fromDate(monday);
      needsUpdate = true;
      console.log('Haftalık rapor sıfırlandı');
    }
    
    // Aylık sıfırlama kontrolü (her ayın 1'i 00:00)
    const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    if (!lastMonthlyReset || lastMonthlyReset < firstOfMonth) {
      updateData.monthlyTotal = 0;
      updateData.lastMonthlyReset = Timestamp.fromDate(firstOfMonth);
      needsUpdate = true;
      console.log('Aylık rapor sıfırlandı');
    }
    
    if (needsUpdate) {
      await updateDoc(raporRef, updateData);
    }
  }
}

// Kat raporu otomatik sıfırlama kontrolü
async function checkFloorAutoReset() {
  const now = new Date();
  const floorReportRef = doc(db, "kat_raporlari", activeFloorGroup);
  const floorReportDoc = await getDoc(floorReportRef);
  
  if (floorReportDoc.exists()) {
    const data = floorReportDoc.data();
    lastFloorDailyReset = data.lastFloorDailyReset ? data.lastFloorDailyReset.toDate() : null;
    lastFloorWeeklyReset = data.lastFloorWeeklyReset ? data.lastFloorWeeklyReset.toDate() : null;
    lastFloorMonthlyReset = data.lastFloorMonthlyReset ? data.lastFloorMonthlyReset.toDate() : null;
    
    let needsUpdate = false;
    const updateData = {};
    
    // Günlük sıfırlama kontrolü (her gün 00:00)
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    if (!lastFloorDailyReset || lastFloorDailyReset < today) {
      updateData.floorDailySales = {};
      updateData.lastFloorDailyReset = Timestamp.fromDate(today);
      needsUpdate = true;
      console.log('Kat raporu günlük sıfırlandı');
    }
    
    // Haftalık sıfırlama kontrolü (her pazartesi 00:00)
    const monday = new Date(now);
    monday.setDate(now.getDate() - now.getDay() + 1); // Pazartesi
    monday.setHours(0, 0, 0, 0);
    if (!lastFloorWeeklyReset || lastFloorWeeklyReset < monday) {
      updateData.floorWeeklySales = {};
      updateData.lastFloorWeeklyReset = Timestamp.fromDate(monday);
      needsUpdate = true;
      console.log('Kat raporu haftalık sıfırlandı');
      }
    
    // Aylık sıfırlama kontrolü (her ayın 1'i 00:00)
    const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    if (!lastFloorMonthlyReset || lastFloorMonthlyReset < firstOfMonth) {
      updateData.floorMonthlySales = {};
      updateData.lastFloorMonthlyReset = Timestamp.fromDate(firstOfMonth);
      needsUpdate = true;
      console.log('Kat raporu aylık sıfırlandı');
    }
    
    if (needsUpdate) {
      await updateDoc(floorReportRef, updateData);
    }
  }
}

async function updateReport() {
  const now = new Date();
  
  // Otomatik sıfırlama kontrolü
  await checkAutoReset();
  
  // Rapor verilerini al
  const raporRef = doc(db, "raporlar", activeFloorGroup);
  const raporDoc = await getDoc(raporRef);
  
  let kaliciToplam = 0;
  let dailyTotalValue = 0;
  let weeklyTotalValue = 0;
  let monthlyTotalValue = 0;
  
  if (raporDoc.exists()) {
    const data = raporDoc.data();
    kaliciToplam = data.kaliciToplam || 0;
    dailyTotalValue = data.dailyTotal || 0;
    weeklyTotalValue = data.weeklyTotal || 0;
    monthlyTotalValue = data.monthlyTotal || 0;
  }
  
  // Tarih formatla
  reportDate.textContent = now.toLocaleDateString('tr-TR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
  
  // Raporları göster
  dailyTotal.textContent = dailyTotalValue.toFixed(2) + ' ₺';
  weeklyTotal.textContent = weeklyTotalValue.toFixed(2) + ' ₺';
  monthlyTotal.textContent = monthlyTotalValue.toFixed(2) + ' ₺';
}
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy,
      onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc, getDocs, where, writeBatch, addDoc, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCVdVGdVmeP5mlikvbQF3AkdQ3JNOg_uco",
      authDomain: "buski-74e3a.firebaseapp.com",
      projectId: "buski-74e3a",
      storageBucket: "buski-74e3a.firebasestorage.app",
      messagingSenderId: "674085318891",
      appId: "1:674085318891:web:00dfb59d7e720c1ca24eae",
      measurementId: "G-DFB2M6XMT3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Menü verisi
    let menuData = [];
    let allOrders = [];
    let activeTab = 'preparing'; // 'preparing', 'delivered' veya 'ratings'
    let activeFloorGroup = '78910'; // Sadece kat 7-8-9-10
    let ratingsData = [];
    let averageRating = 0.0;
    // DOM Elemanları
    const menuModal = document.getElementById('menu-modal');
    const menuListContainer = document.getElementById('menu-list');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const openMenuBtn = document.getElementById('open-menu-btn');
    const addProductModal = document.getElementById('add-product-modal');
    const closeAddProductBtn = document.getElementById('close-add-product-btn');
    const addProductForm = document.getElementById('add-product-form');
    const editProductModal = document.getElementById('edit-product-modal');
    const closeEditProductBtn = document.getElementById('close-edit-product-btn');
    const editProductForm = document.getElementById('edit-product-form');
    const editProductNameInput = document.getElementById('edit-product-name');
    const editProductPriceInput = document.getElementById('edit-product-price');
    const editProductTeaTicketsInput = document.getElementById('edit-product-tea-tickets');
    const editProductOptionsInput = document.getElementById('edit-product-options');
    const addProductInStockInput = document.getElementById('add-product-instock');
    const editProductInStockInput = document.getElementById('edit-product-instock');
    const preparingTab = document.getElementById('preparing-tab');
    const deliveredTab = document.getElementById('delivered-tab');
    const ratingsTab = document.getElementById('ratings-tab');
    const floorsContainer = document.getElementById('floors-container');
    const ratingsContainer = document.getElementById('ratings-container');

    
    // Yeni sipariş ID'leri için değişken
    let newOrderIds = new Set();
    const refreshRatingsBtn = document.getElementById('refresh-ratings-btn');
    const averageRatingSpan = document.getElementById('average-rating');
    const averageStarsDiv = document.getElementById('average-stars');
    const totalRatingsSpan = document.getElementById('total-ratings');
    const ratingsListDiv = document.getElementById('ratings-list');
    const floorGroupButtons = document.querySelectorAll('.floor-group-btn');
    const deleteAllOrdersBtn = document.getElementById('delete-all-orders-btn');
    
    // Badge elementleri
    const preparingBadge = document.getElementById('preparing-alert');
    const deliveredBadge = document.getElementById('delivered-alert');
    const ratingsBadge = document.getElementById('ratings-alert');
    
    let editingProductIndex = -1;
    // Modal olay dinleyicileri
    openMenuBtn.addEventListener('click', () => {
      renderMenuList();
      menuModal.style.display = 'flex';
    });
    
    // İkinci menü butonu için event listener
    const openMenuBtnSecondary = document.getElementById('open-menu-btn-secondary');
    if (openMenuBtnSecondary) {
      openMenuBtnSecondary.addEventListener('click', () => {
        renderMenuList();
        menuModal.style.display = 'flex';
      });
    }
    
    closeMenuBtn.addEventListener('click', () => {
      menuModal.style.display = 'none';
    });
    closeAddProductBtn.addEventListener('click', () => {
      addProductModal.style.display = 'none';
    });
    closeEditProductBtn.addEventListener('click', () => {
      editProductModal.style.display = 'none';
    });

    

    
    // Yeni sipariş kartlarını yanıp söndür
    function blinkNewOrderCards() {
      console.log('blinkNewOrderCards çağrıldı');
      console.log('newOrderIds:', newOrderIds);
      
      const newCards = document.querySelectorAll('.new-order-card');
      console.log('Bulunan yeni kartlar:', newCards.length);
      
      newCards.forEach(card => {
        console.log('Kart yanıp sönüyor:', card);
        let blinkCount = 0;
        const blinkInterval = setInterval(() => {
          blinkCount++;
          console.log('Yanıp sönme sayısı:', blinkCount);
          if (blinkCount >= 4) { // 4 kez yanıp sön
            clearInterval(blinkInterval);
            card.classList.remove('new-order-card');
            console.log('Yanıp sönme tamamlandı');
          }
        }, 1000);
      });
      
      // Eğer yeni kart bulunamadıysa, newOrderIds'deki ID'lere sahip kartları bul
      if (newCards.length === 0 && newOrderIds.size > 0) {
        console.log('Yeni kartlar bulunamadı, ID\'lerle arama yapılıyor...');
        newOrderIds.forEach(orderId => {
          const card = document.querySelector(`[data-order-id="${orderId}"]`);
          if (card) {
            console.log('ID ile kart bulundu:', orderId);
            card.classList.add('new-order-card');
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
              blinkCount++;
              if (blinkCount >= 4) {
                clearInterval(blinkInterval);
                card.classList.remove('new-order-card');
              }
            }, 1000);
          }
        });
      }
    }

    // Bildirim işaretini 5 saniye boyunca yanıp söndür ve ses çal
    let notificationTimeoutId = null;
    function showNotificationAlert() {
      const notificationSound = document.getElementById('notification-sound');
      const preparingBadge = document.getElementById('preparing-alert');
      
      if (preparingBadge && notificationSound) {
        // Ses her zaman çal
        notificationSound.currentTime = 0;
        notificationSound.play().catch(error => {
          console.log('Ses çalınamadı:', error);
        });
        
        // Bildirim işareti sadece teslim edilenler veya puanlar sekmesindeyken yanıp sönsün
        if (activeTab === 'delivered' || activeTab === 'ratings') {
          // Önceki timeout'u temizle
          if (notificationTimeoutId) {
            clearTimeout(notificationTimeoutId);
          }
          
          // Bildirim işaretini göster
          preparingBadge.classList.remove('hidden');
          
          // 5 saniye sonra bildirim işaretini gizle
          notificationTimeoutId = setTimeout(() => {
            preparingBadge.classList.add('hidden');
            notificationTimeoutId = null;
            console.log('Bildirim işareti 5 saniye sonra gizlendi');
          }, 5000);
          
          console.log('Bildirim işareti 5 saniye boyunca gösterildi (teslim edilenler/puanlar sekmesinde)');
        } else {
          console.log('Bildirim işareti gösterilmedi (hazırlananlar sekmesinde)');
        }
        
        console.log('Ses çalındı ve bildirim işareti durumu kontrol edildi');
      }
    }

    // Sekme değişiklikleri
    preparingTab.addEventListener('click', () => {
      setActiveTab('preparing');
      // Yeni sipariş kartlarını yanıp söndür
      setTimeout(() => {
        blinkNewOrderCards();
      }, 100);
    });
    deliveredTab.addEventListener('click', () => {
      setActiveTab('delivered');
    });
    ratingsTab.addEventListener('click', () => {
      setActiveTab('ratings');
    });
    

    
    // Tüm puanları sil butonu
    const deleteAllRatingsBtn = document.getElementById('delete-all-ratings-btn');
    deleteAllRatingsBtn.addEventListener('click', () => {
      deleteAllRatings();
    });
    
    // Real-time puanlama listener'ı - Siparişlerden
    const ratingsQuery = query(
      collection(db, "siparisler"),
      where("rating", ">", 0)
    );
    
    onSnapshot(ratingsQuery, (snapshot) => {
      loadRatings();
    });
    
    // Real-time puanlama listener'ı - Ratings koleksiyonundan
    const ratingsCollectionQuery = query(collection(db, "ratings"));
    
    onSnapshot(ratingsCollectionQuery, (snapshot) => {
      loadRatings();
    });
    
    // Korunan puanlamalar için de listener
    const preservedRatingsQuery = query(collection(db, "preserved_ratings"));
    
    onSnapshot(preservedRatingsQuery, (snapshot) => {
      loadRatings();
    });
    
    // Tüm siparişleri sil butonu olay dinleyicisi
    if (deleteAllOrdersBtn) {
      deleteAllOrdersBtn.addEventListener('click', () => {
        deleteAllOrders();
      });
    }
    // Kat grubu değişiklikleri - Sadece kat 7-8-9-10
    // Bu panel sadece kat 7-8-9-10 için olduğundan değişiklik yok
    // Menü listesini render et
    function renderMenuList() {
      menuListContainer.innerHTML = '';
      menuData.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'menu-item';
        const inStock = item.inStock !== false; // Varsayılan true
        row.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-gray-800">${escapeHtml(item.name)}</div>
              <div class="text-gray-600 mt-1">${item.price} ₺</div>
              <div class="text-gray-500 text-sm mt-1">${item.options && item.options.length ? 'Opsiyonlar: ' + escapeHtml(item.options.join(', ')) : 'Opsiyon yok'}</div>
            </div>
            <div class="flex items-center gap-2">
              <button
                class="text-blue-600 hover:text-blue-800 p-2"
                title="Düzenle"
                data-idx="${idx}"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="text-gray-500 hover:text-gray-700 p-2"
                title="Stok Durumu"
                data-stock-idx="${idx}"
              >
                <i class="fas ${inStock ? 'fa-eye' : 'fa-eye-slash'}"></i>
              </button>
            </div>
          </div>
        `;
        const editButton = row.querySelector('button[data-idx]');
        editButton.addEventListener('click', (e) => {
          editingProductIndex = Number(e.currentTarget.getAttribute('data-idx'));
          const productToEdit = menuData[editingProductIndex];
          editProductNameInput.value = productToEdit.name;
          editProductPriceInput.value = productToEdit.price;
          editProductTeaTicketsInput.value = productToEdit.teaTickets || 0;
          editProductOptionsInput.value = productToEdit.options.join(', ');
          // Stok durumu checkbox'ı
          if (editProductInStockInput) {
            editProductInStockInput.checked = productToEdit.inStock !== false;
          }
          editProductModal.style.display = 'flex';
        });
        // Göz (stok) butonu
        const stockButton = row.querySelector('button[data-stock-idx]');
        stockButton.addEventListener('click', async (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-stock-idx'));
          menuData[idx].inStock = !(menuData[idx].inStock !== false);
          await saveMenuToFirestore();
          renderMenuList();
        });
        menuListContainer.appendChild(row);
      });
      const addProductCard = document.createElement('div');
      addProductCard.className = 'add-product-card mt-2';
      addProductCard.innerHTML = `
        <i class="fas fa-plus-circle text-2xl text-gray-400 mb-2"></i>
        <div class="text-gray-600 font-medium">Yeni Ürün Ekle</div>
      `;
      addProductCard.addEventListener('click', () => {
        addProductModal.style.display = 'flex';
      });
      menuListContainer.appendChild(addProductCard);
    }
    // Yardımcı fonksiyon: HTML kaçış
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
    // Yeni ürün ekleme form submit
    addProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(addProductForm);
      const name = formData.get('product-name').trim();
      const price = parseFloat(formData.get('product-price'));
      const teaTickets = parseInt(formData.get('product-tea-tickets')) || 0;
      const optionsText = formData.get('product-options').trim();
      if (!name || isNaN(price) || price < 0) {
        alert('Lütfen geçerli ürün adı ve fiyat giriniz.');
        return;
      }
      const options = optionsText ? optionsText.split(',').map(opt => opt.trim()).filter(opt => opt) : [];
      const defaultOption = options.length > 0 ? options[0] : '';
      const newProduct = {
        name: name,
        price: price,
        teaTickets: teaTickets,
        options: options,
        defaultOption: defaultOption,
        inStock: addProductInStockInput.checked
      };
      menuData.push(newProduct);
      await saveMenuToFirestore();
      addProductModal.style.display = 'none';
      addProductForm.reset();
      renderMenuList();
    });
    // Ürün düzenleme form submit
    editProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editProductForm);
      const name = formData.get('edit-product-name').trim();
      const price = parseFloat(formData.get('edit-product-price'));
      const teaTickets = parseInt(formData.get('edit-product-tea-tickets')) || 0;
      const optionsText = formData.get('edit-product-options').trim();
      if (!name || isNaN(price) || price < 0) {
        alert('Lütfen geçerli ürün adı ve fiyat giriniz.');
        return;
      }
      const options = optionsText ? optionsText.split(',').map(opt => opt.trim()).filter(opt => opt) : [];
      const defaultOption = options.length > 0 ? options[0] : '';
      if (editingProductIndex !== -1) {
        menuData[editingProductIndex] = {
          name: name,
          price: price,
          teaTickets: teaTickets,
          options: options,
          defaultOption: defaultOption,
          inStock: editProductInStockInput.checked
        };
        await saveMenuToFirestore();
      }
      editProductModal.style.display = 'none';
      renderMenuList();
    });
    // Ürün silme
    document.getElementById('delete-product-btn').addEventListener('click', async () => {
      if (editingProductIndex !== -1) {
        if (!confirm('Bu ürünü silmek istediğinizden emin misiniz?')) return;
        try {
          menuData.splice(editingProductIndex, 1);
          await saveMenuToFirestore();
          editProductModal.style.display = 'none';
          renderMenuList();
        } catch (error) {
          console.error('Ürün silinirken hata:', error);
          alert('Ürün silinirken bir hata oluştu!');
        }
      }
    });
    // Firestore'dan menüyü oku - Kat 7-8-9-10 için
    async function fetchMenuFromFirestore() {
      const menuDocRef = doc(db, "menu", "kat78910");
      const menuDoc = await getDoc(menuDocRef);
      if (menuDoc.exists()) {
        menuData = menuDoc.data().items || [];
      } else {
        menuData = [];
        await setDoc(menuDocRef, { items: menuData });
      }
      renderMenuList();
    }
    // Firestore'a menüyü kaydet - Kat 7-8-9-10 için
    async function saveMenuToFirestore() {
      const menuDocRef = doc(db, "menu", "kat78910");
      await setDoc(menuDocRef, { items: menuData });
    }
    // Firestore'daki menüde değişiklikleri dinle - Kat 7-8-9-10 için
    function listenMenuRealtime() {
      const menuDocRef = doc(db, "menu", "kat78910");
      onSnapshot(menuDocRef, (docSnap) => {
        if (docSnap.exists()) {
          menuData = docSnap.data().items || [];
          renderMenuList();
        }
      });
    }
    // Puanlama silme fonksiyonu
    window.deleteRating = async function(ratingId) {
      const confirmed = await showConfirm('Değerlendirmeyi Sil', 'Bu değerlendirmeyi silmek istediğinizden emin misiniz?', 'danger');
      if (confirmed) {
        try {
          // Önce korunan puanlamalarda ara
          const preservedRef = doc(db, "preserved_ratings", ratingId);
          const preservedDoc = await getDoc(preservedRef);
          
          if (preservedDoc.exists()) {
            // Korunan puanlamadan sil
            await deleteDoc(preservedRef);
          } else {
            // Ratings koleksiyonunda ara
            const ratingsRef = doc(db, "ratings", ratingId);
            const ratingsDoc = await getDoc(ratingsRef);
            
            if (ratingsDoc.exists()) {
              // Ratings koleksiyonundan sil
              await deleteDoc(ratingsRef);
            } else {
              // Normal siparişten puanlamayı sil
              const ref = doc(db, "siparisler", ratingId);
              await updateDoc(ref, { 
                rating: 0, 
                comment: '', 
                ratingDate: null 
              });
            }
          }
          
          // Puanlamaları yeniden yükle
          loadRatings();
        } catch (error) {
          console.error("Değerlendirme silinirken hata oluştu:", error);
          await showAlert("Değerlendirme silinirken bir sorun oluştu.", 'error');
        }
      }
    };

    // Tüm puanları sil
    window.deleteAllRatings = async function() {
      const confirmed = await showConfirm('Tüm Değerlendirmeleri Sil', 'Tüm puanları ve yorumları kalıcı olarak silmek istediğinizden emin misiniz?', 'danger');
      if (confirmed) {
        try {
          // Kat grubuna göre siparişleri filtrele
          const filteredOrders = filterOrdersByPanel(allOrders);
          const ordersWithRatings = filteredOrders.filter(order => order.rating && order.rating > 0);
          
          // Tüm puanları sil
          const batch = writeBatch(db);
          ordersWithRatings.forEach(order => {
            const orderRef = doc(db, "siparisler", order.id);
            batch.update(orderRef, {
              rating: 0,
              comment: "",
              ratingDate: null
            });
          });
          
          await batch.commit();
          
          // Ratings koleksiyonundan da sil
          const ratingsSnapshot = await getDocs(collection(db, "ratings"));
          const ratingsBatch = writeBatch(db);
          ratingsSnapshot.docs.forEach(doc => {
            const ratingData = doc.data();
            const floor = Number(ratingData.userFloor || 0);
            if (floor >= 7 && floor <= 10) { // Kat 7-8-9-10
              ratingsBatch.delete(doc.ref);
            }
          });
          await ratingsBatch.commit();
          
          // Korunan puanlamaları da sil
          const preservedSnapshot = await getDocs(collection(db, "preserved_ratings"));
          const preservedBatch = writeBatch(db);
          preservedSnapshot.docs.forEach(doc => {
            const ratingData = doc.data();
            const floor = Number(ratingData.userFloor || 0);
            if (floor >= 7 && floor <= 10) { // Kat 7-8-9-10
              preservedBatch.delete(doc.ref);
            }
          });
          await preservedBatch.commit();
          
          // Puanları yeniden yükle
          loadRatings();
          
          if (ordersWithRatings.length > 0) {
            await showAlert(`${ordersWithRatings.length} Değerlendirme başarıyla silindi.`, 'success');
          }
          
        } catch (error) {
          console.error("Tüm değerlendirmeler silinirken hata oluştu:", error);
          await showAlert("Tüm değerlendirmeler silinirken bir sorun oluştu.", 'error');
        }
      }
    };

    // Sekme değiştirme
    function setActiveTab(tab) {
      activeTab = tab;
      
      // Tüm sekmeleri pasif yap
      preparingTab.classList.remove('tab-active');
      preparingTab.classList.add('tab-inactive');
      deliveredTab.classList.remove('tab-active');
      deliveredTab.classList.add('tab-inactive');
      ratingsTab.classList.remove('tab-active');
      ratingsTab.classList.add('tab-inactive');
      
      // Tüm container'ları gizle
      floorsContainer.classList.add('hidden');
      ratingsContainer.classList.add('hidden');
      
      if (tab === 'preparing') {
        preparingTab.classList.add('tab-active');
        preparingTab.classList.remove('tab-inactive');
        floorsContainer.classList.remove('hidden');
        deleteAllOrdersBtn.classList.add('hidden');
        deleteAllRatingsBtn.classList.add('hidden');
        renderFloors();
      } else if (tab === 'delivered') {
        deliveredTab.classList.add('tab-active');
        deliveredTab.classList.remove('tab-inactive');
        floorsContainer.classList.remove('hidden');
        deleteAllRatingsBtn.classList.add('hidden');
        renderFloors();
        // Butonu tekrar bul ve hidden class'ını kaldır
        const newDeleteAllOrdersBtn = document.getElementById('delete-all-orders-btn');
        if (newDeleteAllOrdersBtn) {
          newDeleteAllOrdersBtn.classList.remove('hidden');
        }
      } else if (tab === 'ratings') {
        ratingsTab.classList.add('tab-active');
        ratingsTab.classList.remove('tab-inactive');
        ratingsContainer.classList.remove('hidden');
        deleteAllOrdersBtn.classList.add('hidden');
        deleteAllRatingsBtn.classList.remove('hidden');
        
        // Eğer puanlamalar zaten yüklendiyse hemen göster, yoksa yükle
        if (ratingsData && ratingsData.length >= 0) {
          renderRatings();
        } else {
          // Puanlamaları arka planda yükle
          setTimeout(() => {
            loadRatings();
          }, 100);
        }
      }
    }

    // Hata butonu işlevi: Siparişi hazırlananlar sekmesine geri döndürür
    window.revertToPreparing = async function(id, btn) {
        const confirmed = await showConfirm('Siparişi Geri Al', 'Bu siparişi hazırlananlar sekmesine geri almak istediğinizden emin misiniz?', 'warning');
        if (confirmed) {
            const ref = doc(db, "siparisler", id);
            try {
                await updateDoc(ref, { status: "hazırlanıyor" });
                
                // Otomatik olarak "Hazırlananlar" sekmesine geç
                if (activeTab !== 'preparing') {
                    setActiveTab('preparing');
                }
                
                console.log("Sipariş durumu güncellendi:", id);
            } catch (error) {
                console.error("Hata durumu güncellenirken hata oluştu:", error);
                await showAlert("Hata durumu güncellenirken bir sorun oluştu.", 'error');
            }
        }
    };

    // Katları render et - Sadece kat 7-8-9-10
    function renderFloors() {
      floorsContainer.innerHTML = '';
      
      const floorsToShow = [
        { floor: 7, name: 'Kat 7' },
        { floor: 8, name: 'Kat 8' },
        { floor: 9, name: 'Kat 9' },
        { floor: 10, name: 'Kat 10' }
      ];
      const groupName = "Kat 7 - 8 - 9 - 10";
      
      const groupRow = document.createElement('div');
      groupRow.className = 'mb-8';
      groupRow.innerHTML = `<h2 class="text-2xl font-bold text-center mb-6 text-gray-800">${groupName}</h2>`;
      const groupGrid = document.createElement('div');
      groupGrid.className = 'floor-grid';
      
      floorsToShow.forEach(({floor, name}) => {
        const floorCard = createFloorCard(floor, name);
        groupGrid.appendChild(floorCard);
      });
      
      groupRow.appendChild(groupGrid);
      floorsContainer.appendChild(groupRow);
      
      // Yeni sipariş kartlarını yanıp söndür
      setTimeout(() => {
        blinkNewOrderCards();
      }, 100);
    }
    // Kat kartı oluştur (floor: kat numarası, floorName: gösterilecek isim)
    function createFloorCard(floor, floorName) {
      const floorCard = document.createElement('div');
      floorCard.className = 'floor-card';
      const title = document.createElement('div');
      title.className = 'font-bold text-lg mb-4 text-center pb-2 border-b';
      title.textContent = floorName;
      floorCard.appendChild(title);
      const ordersContainer = document.createElement('div');
      ordersContainer.className = 'order-list';
      // Aktif sekmeye göre siparişleri filtrele
      let filteredOrders = [];
      if (activeTab === 'preparing') {
        filteredOrders = allOrders.filter(order => 
          Number(order.floor) === floor && 
          order.status !== "teslim edildi" &&
          order.status !== "silindi"
        );
      } else {
        filteredOrders = allOrders.filter(order => 
          Number(order.floor) === floor && 
          order.status === "teslim edildi" &&
          order.status !== "silindi"
        );
      }
      if (filteredOrders.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state text-center py-8';
        emptyState.innerHTML = `
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p class="mt-2">${activeTab === 'preparing' ? 'Hazırlanacak sipariş yok' : 'Teslim edilen sipariş yok'}</p>
        `;
        ordersContainer.appendChild(emptyState);
      } else {
        filteredOrders.forEach(order => {
          const orderCard = createOrderCard(order);
          ordersContainer.appendChild(orderCard);
        });
      }
      floorCard.appendChild(ordersContainer);
      return floorCard;
    }
    // Sipariş kartı oluştur
    function createOrderCard(order) {
      const card = document.createElement('div');
      const status = order.status || "hazırlanıyor";
      // Kart sınıfını belirle
      let cardClass = 'order-card p-4 mb-3';
      if (status === 'hazırlanıyor') {
        cardClass += ' order-card-preparing';
      } else if (status === 'hazırlandı') {
        cardClass += ' order-card-ready';
      } else if (status === 'teslim edildi') {
        cardClass += ' order-card-delivering';
      }
      
      // Yeni gelen sipariş ise yanıp sönen sınıf ekle
      if (newOrderIds.has(order.id)) {
        cardClass += ' new-order-card';
      }
      
      card.className = cardClass;
      card.setAttribute('data-order-id', order.id);
      // Ad soyad
      const fullName = order.fullName || order.ad || '';
      // Ürünler listesi
      let itemsHtml = '-';
      if (Array.isArray(order.items) && order.items.length > 0) {
        itemsHtml = order.items.map(item => {
          const option = item.option || item.sugar || null;
          return `<div class='flex justify-between items-center bg-white rounded-lg px-3 py-2 mb-2 border border-gray-100'>
            <div class='flex flex-col'>
              <span class='font-medium text-gray-900'>${escapeHtml(item.name)}</span>
              ${option ? `<span class='text-sm text-gray-600'>${escapeHtml(option)}</span>` : ''}
              ${item.teaTickets ? `<span class='text-xs text-blue-600'>${item.teaTickets * item.adet} Fiş</span>` : ''}
            </div>
            <div class='flex items-center space-x-3'>
              <span class='bg-green-100 text-green-700 text-sm font-bold px-3 py-1 rounded'>${item.adet} adet</span>
              <span class='font-bold text-black'>${escapeHtml(((item.price || item.fiyat || 0) * item.adet).toString())} ₺</span>
            </div>
          </div>`;
        }).join('');
      }
      // Buton metni ve sınıfı
      let buttonText = 'Hazırlanıyor...';
      let buttonClass = 'status-btn btn-preparing';
      let buttonIcon = '<i class="fas fa-spinner mr-2"></i>';
      let disabled = false;
      let buttonExtra = '';
      if (status === 'hazırlandı') {
        buttonText = 'Hazırlandı';
        buttonClass = 'status-btn btn-ready';
        buttonIcon = '<i class="fas fa-check mr-2"></i>';
      } else if (status === 'teslim edildi') {
        buttonText = 'Teslim Edildi';
        buttonClass = 'status-btn btn-delivering';
        buttonIcon = '<i class="fas fa-check-circle mr-2"></i><i class=\'fas fa-times mr-2\'></i>';
        disabled = true;
        buttonExtra = 'data-delivered="1"';
      }
      card.innerHTML = `
        <div class="flex items-center mb-2">
          <i class="fas fa-user-circle text-2xl text-blue-400 mr-2"></i>
          <div>
            <div class="font-bold text-base">${escapeHtml(fullName)}</div>
                        <div class="text-xs text-gray-500"><i class='fas fa-building mr-1'></i>${escapeHtml(order.departman || '')}${order.floor ? ' - ' + order.floor + '. Kat' : ''}</div>
          </div>
          <div class="ml-auto text-right">
            <div class="text-xs text-gray-400">${order.tarih?.toDate ? order.tarih.toDate().toLocaleDateString('tr-TR', { day: '2-digit', month: 'long' }) : ''}</div>
            <div class="text-lg font-bold text-gray-700">${order.tarih?.toDate ? order.tarih.toDate().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : ''}</div>
          </div>
        </div>
        <div class="font-semibold text-gray-700 mt-2 mb-1">SİPARİŞ İÇERİĞİ</div>
        <div>${itemsHtml}</div>
        <div class="bg-gray-50 rounded-lg px-3 py-2 mt-2 mb-1 flex justify-between items-center">
          <span class="font-medium">Toplam Tutar</span>
          <span class="font-bold text-xl text-black">${escapeHtml((order.toplamFiyat || 0).toString())} ₺</span>
        </div>
        ${status === 'teslim edildi' && order.rating ? `
        <div class="bg-white rounded-lg px-3 py-2 mt-2 mb-1 flex justify-between items-center border border-gray-100">
          <span class="font-medium">Müşteri Puanı</span>
          <span class="flex items-center">
            ${Array.from({length: 5}, (_, i) =>
              `<i class='fas fa-star ${i < order.rating ? 'text-yellow-400' : 'text-gray-300'}' style='font-size: 18px;'></i>`
            ).join('')}
            <span class="ml-2 font-bold text-gray-700">${order.rating}/5</span>
          </span>
        </div>
        ` : ''}
        <div class="flex justify-between items-center mt-3 pt-3 border-t relative">
          <button class="${buttonClass} px-3 py-2 text-sm" onclick="cycleStatus('${order.id}', this)" ${disabled ? 'disabled' : ''} ${buttonExtra}>
            ${buttonIcon}${buttonText}
          </button>
          <button class="delete-icon-btn ${activeTab === 'preparing' ? 'delete-icon-preparing' : 'delete-icon-delivered'}"
                  onclick="deleteOrder('${order.id}', this)"
                  title="Siparişi Sil">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      return card;
    }
    // Sipariş durumunu değiştir
    window.cycleStatus = async function (id, btn) {
      const ref = doc(db, "siparisler", id);
      const order = allOrders.find(o => o.id === id);
      if (!order) return;
      const currentStatus = order.status || "hazırlanıyor";
      if (currentStatus === "hazırlanıyor") {
        await updateDoc(ref, { status: "hazırlandı" });
        // Kullanıcı geçmişini güncelle
        await updateUserHistoryStatus(order, "hazırlandı");
      } else if (currentStatus === "hazırlandı") {
        const card = btn.closest('.order-card');
        if (card) {
          // Kartı kırmızı yap ve bounce animasyonu uygula
          card.classList.remove('order-card-ready');
          card.classList.add('order-card-delivering', 'fade-out');
          setTimeout(async () => {
            await updateDoc(ref, { status: "teslim edildi" });
            await increaseReportTotal(order);
            // Kullanıcı geçmişine kaydet
            await saveToUserHistory(order);
          }, 600);
        } else {
          await updateDoc(ref, { status: "teslim edildi" });
          await increaseReportTotal(order);
          // Kullanıcı geçmişine kaydet
          await saveToUserHistory(order);
        }
      }
      updateBadges();
    };

    // Rapor toplamını artıran fonksiyon
    async function increaseReportTotal(order) {
      try {
        const raporRef = doc(db, "raporlar", activeFloorGroup);
        const raporDoc = await getDoc(raporRef);
        
        const now = new Date();
        const orderAmount = order.toplamFiyat || 0;
        
        let reportData = {
          kaliciToplam: 0,
          dailyTotal: 0,
          weeklyTotal: 0,
          monthlyTotal: 0,
          eklenenSiparisler: [],
          lastDailyReset: Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate())),
          lastWeeklyReset: Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1)),
          lastMonthlyReset: Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), 1))
        };
        
        if (raporDoc.exists()) {
          const existingData = raporDoc.data();
          reportData = {
            ...reportData,
            ...existingData
          };
          
          // Sipariş zaten eklendiyse tekrar ekleme
          const eklenenSiparisler = existingData.eklenenSiparisler || [];
          if (eklenenSiparisler.includes(order.id)) return;
          
          eklenenSiparisler.push(order.id);
          reportData.eklenenSiparisler = eklenenSiparisler;
          reportData.kaliciToplam = (existingData.kaliciToplam || 0) + orderAmount;
          
          // Günlük, haftalık ve aylık toplamları güncelle
          reportData.dailyTotal = (existingData.dailyTotal || 0) + orderAmount;
          reportData.weeklyTotal = (existingData.weeklyTotal || 0) + orderAmount;
          reportData.monthlyTotal = (existingData.monthlyTotal || 0) + orderAmount;
        } else {
          reportData.kaliciToplam = orderAmount;
          reportData.dailyTotal = orderAmount;
          reportData.weeklyTotal = orderAmount;
          reportData.monthlyTotal = orderAmount;
          reportData.eklenenSiparisler = [order.id];
        }
        
        await setDoc(raporRef, reportData);
        
        // Kat raporunu da güncelle
        await updateFloorReportData(order);
      } catch (error) {
        console.error('Rapor toplamı artırılırken hata:', error);
      }
    }
    
    // Kullanıcı geçmişine kaydetme fonksiyonu
    async function saveToUserHistory(order) {
      try {
        if (!order.userId) {
          console.log('Sipariş userId bilgisi yok, kullanıcı geçmişine kaydedilemiyor');
          return;
        }
        
        // Kullanıcı geçmişine kaydet
        const userHistoryRef = doc(db, "user_order_history", order.userId, "orders", order.id);
        await setDoc(userHistoryRef, {
          ...order,
          status: "teslim edildi", // Durumu kesin olarak teslim edildi yap
          savedAt: new Date(),
          originalOrderId: order.id
        });
        
        console.log(`Sipariş ${order.id} kullanıcı geçmişine kaydedildi`);
      } catch (error) {
        console.error('Kullanıcı geçmişine kaydetme hatası:', error);
      }
    }
    
    // Kullanıcı geçmişindeki sipariş durumunu güncelleme fonksiyonu
    async function updateUserHistoryStatus(order, newStatus) {
      try {
        if (!order.userId) {
          console.log('Sipariş userId bilgisi yok, kullanıcı geçmişi güncellenemiyor');
          return;
        }
        
        // Kullanıcı geçmişindeki sipariş durumunu güncelle
        const userHistoryRef = doc(db, "user_order_history", order.userId, "orders", order.id);
        await updateDoc(userHistoryRef, {
          status: newStatus,
          updatedAt: new Date()
        });
        
        console.log(`Sipariş ${order.id} kullanıcı geçmişinde durumu güncellendi: ${newStatus}`);
      } catch (error) {
        console.error('Kullanıcı geçmişi güncelleme hatası:', error);
      }
    }
    
    // Kat raporu verilerini güncelleyen fonksiyon
    async function updateFloorReportData(order) {
      try {
        const floorReportRef = doc(db, "kat_raporlari", activeFloorGroup);
        const floorReportDoc = await getDoc(floorReportRef);
        
        const now = new Date();
        const orderAmount = order.toplamFiyat || 0;
        const floor = order.floor || 0;
        
        let reportData = {
          floorSales: {},
          floorDailySales: {},
          floorWeeklySales: {},
          floorMonthlySales: {},
          lastFloorDailyReset: Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate())),
          lastFloorWeeklyReset: Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1)),
          lastFloorMonthlyReset: Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), 1)),
          lastUpdated: Timestamp.now(),
          floorGroup: activeFloorGroup
        };
        
        if (floorReportDoc.exists()) {
          const existingData = floorReportDoc.data();
          reportData = {
            ...reportData,
            ...existingData
          };
        }
        
        // Kalıcı verileri güncelle
        if (!reportData.floorSales[floor]) {
          reportData.floorSales[floor] = {
            total: 0,
            count: 0,
            items: {},
            orders: []
          };
        }
        
        // Günlük verileri güncelle
        if (!reportData.floorDailySales[floor]) {
          reportData.floorDailySales[floor] = {
            total: 0,
            count: 0,
            items: {},
            orders: []
          };
        }
        
        // Haftalık verileri güncelle
        if (!reportData.floorWeeklySales[floor]) {
          reportData.floorWeeklySales[floor] = {
            total: 0,
            count: 0,
            items: {},
            orders: []
          };
        }
        
        // Aylık verileri güncelle
        if (!reportData.floorMonthlySales[floor]) {
          reportData.floorMonthlySales[floor] = {
            total: 0,
            count: 0,
            items: {},
            orders: []
          };
        }
        
        // Sipariş zaten eklenmiş mi kontrol et (kalıcı veriler için)
        const orderExists = reportData.floorSales[floor].orders.some(existingOrder => existingOrder.id === order.id);
        if (!orderExists) {
          // Kalıcı verileri güncelle
          reportData.floorSales[floor].total += orderAmount;
          reportData.floorSales[floor].count += 1;
          
          // Günlük verileri güncelle
          reportData.floorDailySales[floor].total += orderAmount;
          reportData.floorDailySales[floor].count += 1;
          
          // Haftalık verileri güncelle
          reportData.floorWeeklySales[floor].total += orderAmount;
          reportData.floorWeeklySales[floor].count += 1;
          
          // Aylık verileri güncelle
          reportData.floorMonthlySales[floor].total += orderAmount;
          reportData.floorMonthlySales[floor].count += 1;
          
          // Sipariş detaylarını sakla
          const orderDetail = {
            id: order.id,
            totalPrice: order.toplamFiyat || 0,
            items: order.items || [],
            date: order.tarih || new Date()
          };
          
          // Tüm periyotlara sipariş detayını ekle
          reportData.floorSales[floor].orders.push(orderDetail);
          reportData.floorDailySales[floor].orders.push(orderDetail);
          reportData.floorWeeklySales[floor].orders.push(orderDetail);
          reportData.floorMonthlySales[floor].orders.push(orderDetail);
          
          // Ürün bazlı satışları da hesapla
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              const itemName = item.name || 'Bilinmeyen Ürün';
              
              // Kalıcı veriler için
              if (!reportData.floorSales[floor].items[itemName]) {
                reportData.floorSales[floor].items[itemName] = {
                  quantity: 0,
                  revenue: 0,
                  tickets: 0
                };
              }
              reportData.floorSales[floor].items[itemName].quantity += item.adet || 1;
              reportData.floorSales[floor].items[itemName].revenue += (item.price || 0) * (item.adet || 1);
              reportData.floorSales[floor].items[itemName].tickets += (item.teaTickets || 0) * (item.adet || 1);
              
              // Günlük veriler için
              if (!reportData.floorDailySales[floor].items[itemName]) {
                reportData.floorDailySales[floor].items[itemName] = {
                  quantity: 0,
                  revenue: 0,
                  tickets: 0
                };
              }
              reportData.floorDailySales[floor].items[itemName].quantity += item.adet || 1;
              reportData.floorDailySales[floor].items[itemName].revenue += (item.price || 0) * (item.adet || 1);
              reportData.floorDailySales[floor].items[itemName].tickets += (item.teaTickets || 0) * (item.adet || 1);
              
              // Haftalık veriler için
              if (!reportData.floorWeeklySales[floor].items[itemName]) {
                reportData.floorWeeklySales[floor].items[itemName] = {
                  quantity: 0,
                  revenue: 0,
                  tickets: 0
                };
              }
              reportData.floorWeeklySales[floor].items[itemName].quantity += item.adet || 1;
              reportData.floorWeeklySales[floor].items[itemName].revenue += (item.price || 0) * (item.adet || 1);
              reportData.floorWeeklySales[floor].items[itemName].tickets += (item.teaTickets || 0) * (item.adet || 1);
              
              // Aylık veriler için
              if (!reportData.floorMonthlySales[floor].items[itemName]) {
                reportData.floorMonthlySales[floor].items[itemName] = {
                  quantity: 0,
                  revenue: 0,
                  tickets: 0
                };
              }
              reportData.floorMonthlySales[floor].items[itemName].quantity += item.adet || 1;
              reportData.floorMonthlySales[floor].items[itemName].revenue += (item.price || 0) * (item.adet || 1);
              reportData.floorMonthlySales[floor].items[itemName].tickets += (item.teaTickets || 0) * (item.adet || 1);
            });
          }
          }
          
          // Firestore'a kaydet
        await setDoc(floorReportRef, reportData);
      } catch (error) {
        console.error('Kat raporu güncellenirken hata:', error);
      }
    }
    // Siparişi sil (geçmiş siparişler için korunur)
    window.deleteOrder = async function(id, btn) {
      const confirmed = await showConfirm('Siparişi Sil', 'Bu siparişi silmek istediğinizden emin misiniz?', 'danger');
      if (confirmed) {
        try {
          const order = allOrders.find(o => o.id === id);
          const ref = doc(db, "siparisler", id);
          
          console.log('Panelden kaldırılacak sipariş:', order); // Debug için
          
          // Siparişi tamamen sil
          await deleteDoc(ref);
          
          // Eğer siparişin puanlaması varsa, puanlama verilerini koru
          if (order && (order.rating > 0 || order.comment)) {
            console.log('Değerlendirme bulundu, korunuyor:', order.rating, order.comment); // Debug için
            
            const ratingData = {
              orderId: id,
              rating: order.rating || 0,
              comment: order.comment || '',
              userName: order.ad || '',
              userDepartment: order.departman || '',
              userFloor: order.floor || 0,
              timestamp: order.tarih || new Date(),
              preservedAt: new Date(),
              items: order.items || [],
              orderItems: order.orderItems || [],
              toplamFiyat: order.toplamFiyat || 0
            };
            
            console.log('Korunan değerlendirme verisi:', ratingData); // Debug için
            
            // Puanlama verilerini ayrı koleksiyonda sakla
            await setDoc(doc(db, "preserved_ratings", id), ratingData);
            console.log('Değerlendirme korundu'); // Debug için
          } else {
            console.log('Değerlendirme bulunamadı, korunmuyor'); // Debug için
          }
          
          const card = btn.closest('.order-card');
          if (card) {
            card.remove();
          }
          // Badge sayılarını güncelle
          updateBadges().catch(console.error);
        } catch (error) {
          console.error('Sipariş kaldırılırken hata oluştu:', error);
          await showAlert('Sipariş kaldırılırken bir hata oluştu: ' + error.message, 'error');
        }
      }
    };
    
    // Tüm teslim edilmiş siparişleri sil fonksiyonu
    async function deleteAllOrders() {
      const confirmed = await showConfirm('Tüm Teslim Edilenleri Sil', 'Tüm teslim edilen siparişleri silmek istediğinizden emin misiniz?', 'danger');
      if (confirmed) {
        try {
          // Panele göre siparişleri filtrele ve sadece teslim edilmiş olanları al
          const filteredOrders = filterOrdersByPanel(allOrders);
          const deliveredOrders = filteredOrders.filter(order => order.status === 'teslim edildi');

          // --- RAPORU GÜNCELLE (kaliciToplam ve eklenenSiparisler) ---
          const raporRef = doc(db, "raporlar", activeFloorGroup);
          const raporDoc = await getDoc(raporRef);
          let kaliciToplam = 0;
          let eklenenSiparisler = [];
          if (raporDoc.exists()) {
            kaliciToplam = raporDoc.data().kaliciToplam || 0;
            eklenenSiparisler = raporDoc.data().eklenenSiparisler || [];
          }
          let yeniToplam = kaliciToplam;
          let yeniEklenenler = [...eklenenSiparisler];
          for (const order of deliveredOrders) {
            if (!yeniEklenenler.includes(order.id)) {
              yeniToplam += order.toplamFiyat || 0;
              yeniEklenenler.push(order.id);
            }
          }
          await setDoc(raporRef, {
            kaliciToplam: yeniToplam,
            eklenenSiparisler: yeniEklenenler,
            lastUpdated: new Date(),
            floorGroup: activeFloorGroup
          }, { merge: true });
          // --- SONU ---

          // Her teslim edilmiş siparişi user_order_history'ye kaydet ve siparisler'den sil
          for (const order of deliveredOrders) {
            // Siparişi user_order_history'ye kaydet
            try {
              await setDoc(doc(db, "user_order_history", order.ad, "orders", order.id), {
                ...order,
                status: 'teslim edildi',
                savedAt: new Date(),
                originalOrderId: order.id
              });
              console.log('Sipariş user_order_history\'ye kaydedildi:', order.id);
            } catch (error) {
              console.error('Sipariş user_order_history\'ye kaydedilirken hata:', error);
            }
            
            // Eğer siparişin puanlaması varsa, puanlama verilerini koru
            if (order.rating > 0 || order.comment) {
              console.log('Toplu silmede değerlendirme korunuyor:', order.id, order.rating, order.comment);
              
              const ratingData = {
                orderId: order.id,
                rating: order.rating || 0,
                comment: order.comment || '',
                userName: order.ad || '',
                userDepartment: order.departman || '',
                userFloor: order.floor || 0,
                timestamp: order.tarih || new Date(),
                preservedAt: new Date(),
                items: order.items || [],
                orderItems: order.orderItems || [],
                toplamFiyat: order.toplamFiyat || 0
              };
              
              // Puanlama verilerini ayrı koleksiyonda sakla
              await setDoc(doc(db, "preserved_ratings", order.id), ratingData);
            }
            
            // Siparişi tamamen silmek yerine, sadece durumunu "silindi" yap
            await updateDoc(doc(db, "siparisler", order.id), { 
              status: "silindi",
              deletedAt: new Date()
            });
          }
          
          // Badge sayılarını güncelle
          await updateBadges().catch(console.error);
          
          // Puanlamaları yeniden yükle
          await loadRatings();
        } catch (error) {
          console.error('Toplu silme işleminde hata oluştu:', error);
          await showAlert('Toplu silme işleminde bir hata oluştu: ' + error.message, 'error');
        }
      }
    }
    
    // Rapor verilerini kaydet
    async function saveReportData() {
      try {
        const now = new Date();
        const dailyTotal = calculateDailyTotal(allOrders, now);
        const weeklyTotal = calculateWeeklyTotal(allOrders, now);
        const monthlyTotal = calculateMonthlyTotal(allOrders, now);
        
        const reportData = {
          dailyTotal: dailyTotal,
          weeklyTotal: weeklyTotal,
          monthlyTotal: monthlyTotal,
          lastUpdated: now,
          floorGroup: activeFloorGroup
        };
        
        await setDoc(doc(db, "raporlar", activeFloorGroup), reportData);
      } catch (error) {
        console.error('Rapor verileri kaydedilirken hata oluştu:', error);
      }
    }
    
    // Rapor verilerini yükle
    async function loadReportData() {
      try {
        const reportDoc = await getDoc(doc(db, "raporlar", activeFloorGroup));
        if (reportDoc.exists()) {
          return reportDoc.data();
        }
      } catch (error) {
        console.error('Rapor verileri yüklenirken hata oluştu:', error);
      }
      return null;
    }
    
    // Rapor sıfırlama fonksiyonu
    async function resetReportData() {
      try {
        const confirmed = await showConfirm('Rapor Verilerini Sıfırla', 'Rapor verilerini sıfırlamak istediğinizden emin misiniz?', 'danger');
        if (confirmed) {
          const raporRef = doc(db, "raporlar", activeFloorGroup);
          await setDoc(raporRef, {
            kaliciToplam: 0,
            eklenenSiparisler: [],
            lastUpdated: new Date(),
            floorGroup: activeFloorGroup
          });
          updateReport();
        }
      } catch (error) {
        console.error('Rapor verileri sıfırlanırken hata oluştu:', error);
        await showAlert('Rapor verileri sıfırlanırken bir hata oluştu: ' + error.message, 'error');
      }
    }
    
    // Custom Alert fonksiyonu
    function showAlert(message, type = 'info') {
      return new Promise((resolve) => {
        const alertModal = document.getElementById('alert-modal');
        const alertContent = document.getElementById('alert-content');
        const alertIcon = document.getElementById('alert-icon');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOk = document.getElementById('alert-ok');
        
        if (!alertModal || !alertContent || !alertIcon || !alertTitle || !alertMessage || !alertOk) {
          console.error('Alert modal elementleri bulunamadı');
          resolve();
          return;
        }
        
        let iconClass = '';
        let title = '';
        switch(type) {
          case 'success': iconClass = 'fas fa-check-circle text-green-500'; title = 'Başarılı'; break;
          case 'error': iconClass = 'fas fa-exclamation-circle text-red-500'; title = 'Hata'; break;
          case 'warning': iconClass = 'fas fa-exclamation-triangle text-yellow-500'; title = 'Uyarı'; break;
          case 'info': iconClass = 'fas fa-info-circle text-blue-500'; title = 'Bilgi'; break;
          default: iconClass = 'fas fa-info-circle text-blue-500'; title = 'Bilgi';
        }
        
        alertIcon.className = iconClass;
        alertTitle.textContent = title;
        alertMessage.textContent = message;
        
        // Body'ye modal-open sınıfını ekle
        document.body.classList.add('modal-open');
        
        alertModal.classList.remove('hidden');
        setTimeout(() => {
          alertContent.classList.remove('scale-95', 'opacity-0');
          alertContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        const handleOk = () => {
          hideAlert();
          resolve();
        };
        
        alertOk.addEventListener('click', handleOk, { once: true });
        
        // ESC tuşu ile kapatma
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleOk();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }

    function hideAlert() {
      const alertModal = document.getElementById('alert-modal');
      const alertContent = document.getElementById('alert-content');
      
      if (!alertModal || !alertContent) {
        console.error('Alert modal elementleri bulunamadı');
        return;
      }
      
      alertContent.classList.remove('scale-100', 'opacity-100');
      alertContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        alertModal.classList.add('hidden');
        // Body'den modal-open sınıfını kaldır
        document.body.classList.remove('modal-open');
      }, 300);
    }

    // Custom Confirm fonksiyonu
    function showConfirm(title, message, type = 'warning') {
      return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirm-modal');
        const confirmContent = document.getElementById('confirm-content');
        const confirmIcon = document.getElementById('confirm-icon');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');
        
        if (!confirmModal || !confirmContent || !confirmIcon || !confirmTitle || !confirmMessage || !confirmOk || !confirmCancel) {
          console.error('Confirm modal elementleri bulunamadı');
          resolve(false);
          return;
        }
        
        let iconClass = '';
        let buttonColor = '';
        switch(type) {
          case 'danger': iconClass = 'fas fa-exclamation-triangle text-red-500'; buttonColor = 'bg-red-600 hover:bg-red-700'; break;
          case 'warning': iconClass = 'fas fa-exclamation-triangle text-yellow-500'; buttonColor = 'bg-yellow-600 hover:bg-yellow-700'; break;
          case 'info': iconClass = 'fas fa-info-circle text-blue-500'; buttonColor = 'bg-blue-600 hover:bg-blue-700'; break;
          default: iconClass = 'fas fa-exclamation-triangle text-yellow-500'; buttonColor = 'bg-yellow-600 hover:bg-yellow-700';
        }
        
        confirmIcon.className = iconClass;
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmOk.className = `px-4 py-2 text-sm font-medium text-white ${buttonColor} rounded-md transition-colors duration-200`;
        
        // Body'ye modal-open sınıfını ekle
        document.body.classList.add('modal-open');
        
        confirmModal.classList.remove('hidden');
        confirmModal.style.display = 'flex';
        setTimeout(() => {
          confirmContent.classList.remove('scale-95', 'opacity-0');
          confirmContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        const handleConfirm = () => {
          hideConfirm();
          resolve(true);
        };
        
        const handleCancel = () => {
          hideConfirm();
          resolve(false);
        };
        
        confirmOk.addEventListener('click', handleConfirm, { once: true });
        confirmCancel.addEventListener('click', handleCancel, { once: true });
        
        // ESC tuşu ile iptal
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }

    function hideConfirm() {
      const confirmModal = document.getElementById('confirm-modal');
      const confirmContent = document.getElementById('confirm-content');
      
      if (!confirmModal || !confirmContent) {
        console.error('Confirm modal elementleri bulunamadı');
        return;
      }
      
      confirmContent.classList.remove('scale-100', 'opacity-100');
      confirmContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        confirmModal.classList.add('hidden');
        confirmModal.style.display = 'none';
        // Body'den modal-open sınıfını kaldır
        document.body.classList.remove('modal-open');
      }, 300);
    }

    // Notification gösterme fonksiyonu
    function showNotification(message, type = 'info') {
      // Basit bir notification sistemi
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'success' ? 'bg-green-500 text-white' : 
        'bg-blue-500 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Rapor sıfırlama butonu olay dinleyicisi
    document.getElementById('reset-report-btn').addEventListener('click', resetReportData);
    // Bildirim sesi çal
    function playOrderNotification() {
      const audio = document.getElementById('order-notification-sound');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Ses çalınamadı:", e));
      }
    }
    
    // Çan sesi çal (sadece yeni sipariş için)
    function playBellSound() {
      const bellAudio = document.getElementById('bell-sound');
      if (bellAudio) {
        bellAudio.currentTime = 0;
        bellAudio.play().catch(e => console.log("Çan sesi çalınamadı:", e));
      }
    }
    // Panele göre siparişleri filtrele
    function filterOrdersByPanel(orders) {
      if (activeFloorGroup === 'z123') {
        // Zemin ve kat 1-2-3
        return orders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 0 && orderFloor <= 3;
        });
      } else if (activeFloorGroup === '456') {
        // Kat 4-5-6
        return orders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 4 && orderFloor <= 6;
        });
      } else if (activeFloorGroup === '78910') {
        // Kat 7-8-9-10
        return orders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 7 && orderFloor <= 10;
        });
      }
              return orders; // Varsayılan olarak tüm siparişler
      }
      
      // Puanları yükle - Sadece kat 7-8-9-10 için
      async function loadRatings() {
        try {
          // Normal siparişlerden puanları çek
          const snapshot = await getDocs(query(
            collection(db, "siparisler"),
            where("rating", ">", 0)
          ));
          
          // Ratings koleksiyonundan puanları çek
          const ratingsSnapshot = await getDocs(collection(db, "ratings"));
          
          // Korunan puanlamalardan da çek
          const preservedSnapshot = await getDocs(collection(db, "preserved_ratings"));
          
          // Normal siparişlerden puanları al
          let normalRatings = snapshot.docs
            .map(doc => ({
              id: doc.id,
              ...doc.data(),
              isPreserved: false,
              fromSiparisler: true
            }))
            .filter(rating => {
              const floor = Number(rating.floor || 0);
              return floor >= 7 && floor <= 10; // Kat 7-8-9-10
            });
          
          // Ratings koleksiyonundan puanları al
          let ratingsCollectionRatings = ratingsSnapshot.docs
            .map(doc => ({
              id: doc.id,
              ...doc.data(),
              isPreserved: false,
              fromRatingsCollection: true
            }))
            .filter(rating => {
              const floor = Number(rating.userFloor || 0);
              return floor >= 7 && floor <= 10; // Kat 7-8-9-10
            });
          
          // Korunan puanlamalardan al
          let preservedRatings = preservedSnapshot.docs
            .map(doc => ({
              id: doc.id,
              ...doc.data(),
              isPreserved: true
            }))
            .filter(rating => {
              const floor = Number(rating.userFloor);
              return floor >= 7 && floor <= 10; // Kat 7-8-9-10
            });
          
          // Duplicate'leri kaldır - orderId'ye göre
          const allRatings = [...normalRatings, ...ratingsCollectionRatings, ...preservedRatings];
          const uniqueRatings = [];
          const seenOrderIds = new Set();
          
          for (let rating of allRatings) {
            const orderId = rating.orderId || rating.id;
            if (!seenOrderIds.has(orderId)) {
              uniqueRatings.push(rating);
              seenOrderIds.add(orderId);
            }
          }
          
          // Tüm puanları tarihe göre sırala
          ratingsData = uniqueRatings.sort((a, b) => {
            // Tarihe göre sırala (en yeni önce)
            const dateA = a.ratingDate && a.ratingDate.toDate ? a.ratingDate.toDate() : 
                         a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(0);
            const dateB = b.ratingDate && b.ratingDate.toDate ? b.ratingDate.toDate() : 
                         b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(0);
            return dateB - dateA;
          });
          
          // Kullanıcı bilgilerini çek - sadece gerekli olanları
          for (let rating of ratingsData) {
            if (rating.userId && !rating.isPreserved && !rating.fromRatingsCollection) {
              // Kullanıcı bilgisi yoksa varsayılan değer ata
              rating.userName = rating.userName || 'İsimsiz Kullanıcı';
            } else if (rating.isPreserved || rating.fromRatingsCollection) {
              // Korunan puanlamalarda ve ratings koleksiyonundan gelen verilerde kullanıcı adı zaten var
              rating.userName = rating.userName || 'İsimsiz Kullanıcı';
            } else {
              rating.userName = 'İsimsiz Kullanıcı';
            }
        }
          
          // Ortalama puanı hesapla
          if (ratingsData.length > 0) {
            const totalRating = ratingsData.reduce((sum, rating) => sum + (rating.rating || 0), 0);
            averageRating = totalRating / ratingsData.length;
          } else {
            averageRating = 0;
          }
          
          console.log('Puanlar yüklendi, renderRatings çağrılıyor');
          renderRatings();
        } catch (error) {
          console.error('Puanlar yüklenirken hata:', error);
        }
      }
      
      // Sipariş içeriği toggle fonksiyonu
      window.toggleOrderContent = function(ratingId) {
        const contentDiv = document.getElementById(`order-content-${ratingId}`);
        const toggleIcon = document.getElementById(`toggle-icon-${ratingId}`);
        
        if (contentDiv.style.display === 'none') {
          contentDiv.style.display = 'block';
          toggleIcon.className = 'fas fa-chevron-up';
        } else {
          contentDiv.style.display = 'none';
          toggleIcon.className = 'fas fa-chevron-down';
        }
      };

      // Puanları render et
      function renderRatings() {
        // Ortalama puanı güncelle
        averageRatingSpan.textContent = averageRating.toFixed(1);
        totalRatingsSpan.textContent = `${ratingsData.length} değerlendirme`;
        
        // Ortalama yıldızları render et
        averageStarsDiv.innerHTML = '';
        for (let i = 0; i < 5; i++) {
          const star = document.createElement('i');
          if (i < Math.floor(averageRating)) {
            star.className = 'fas fa-star text-yellow-400 text-2xl';
          } else if (i < averageRating) {
            star.className = 'fas fa-star-half-alt text-yellow-400 text-2xl';
          } else {
            star.className = 'far fa-star text-gray-300 text-2xl';
          }
          averageStarsDiv.appendChild(star);
        }
        
        // Puan listesini render et
        ratingsListDiv.innerHTML = '';
        
        if (ratingsData.length === 0) {
          ratingsListDiv.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-star text-4xl text-gray-300 mb-4"></i>
              <p class="text-gray-500 text-lg">Henüz Değerlendirme yapılmamış</p>
            </div>
          `;
          return;
        }
        
        for (const rating of ratingsData) {
          const ratingCard = document.createElement('div');
          ratingCard.className = 'bg-white rounded-lg shadow-md p-6';
          
          const ratingValue = rating.rating || 0;
          const comment = rating.comment || '';
          const userName = rating.userName || 'İsimsiz Kullanıcı';
          const floor = rating.floor || rating.userFloor || 0;
          const floorName = floor === 0 ? 'Zemin' : `Kat ${floor}`;
          const displayName = userName !== 'İsimsiz Kullanıcı' ? `${userName} (${floorName})` : `İsimsiz Kullanıcı (${floorName})`;
          // Orijinal puanlama tarihini kullan, yoksa sipariş tarihini kullan
          const tarih = rating.ratingDate && rating.ratingDate.toDate ? 
            rating.ratingDate.toDate() : 
            (rating.timestamp && rating.timestamp.toDate ? 
              rating.timestamp.toDate() : 
              (rating.tarih && rating.tarih.toDate ? 
                rating.tarih.toDate() : new Date()));
          
          // Sipariş içeriğini hazırla (her zaman preserved rating'den de bak)
          let orderContent = '';
          let items = rating.items && Array.isArray(rating.items) && rating.items.length > 0 ? rating.items : (rating.orderItems && Array.isArray(rating.orderItems) && rating.orderItems.length > 0 ? rating.orderItems : []);
          if (items.length > 0) {
            orderContent = items.map(item => 
              `${escapeHtml(item.name)}${item.option ? ' (' + escapeHtml(item.option) + ')' : ''} - ${escapeHtml(item.adet?.toString() || '1')} adet`
            ).join('<br>');
          } else {
            orderContent = '';
          }
          
          let starsHtml = '';
          for (let i = 0; i < 5; i++) {
            starsHtml += `<i class="fas fa-star ${i < ratingValue ? 'text-yellow-400' : 'text-gray-300'}" style="font-size: 16px;"></i>`;
          }
          
                  ratingCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-bold text-lg text-gray-800">${escapeHtml(displayName)}</h3>
              <div class="flex items-center gap-4 text-sm text-gray-500 mt-1">
                <span><i class="fas fa-building mr-1"></i>${floorName}</span>
                <span><i class="fas fa-clock mr-1"></i>${tarih.toLocaleDateString('tr-TR')} ${tarih.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</span>
                ${rating.userDepartment ? `<span><i class="fas fa-users mr-1"></i>${escapeHtml(rating.userDepartment)}</span>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-2">
              ${starsHtml}
              <span class="ml-2 text-sm text-gray-500">(${ratingValue}/5)</span>

            </div>
          </div>
          
          <!-- Personel Bilgisi - Her zaman göster -->
          ${(rating.selectedPersonnel || rating.deliveryPersonnel || rating.garson) ? `
            <div class="bg-green-50 rounded-lg p-3 mb-3">
              <div class="flex items-center">
                <i class="fas fa-user-check text-green-600 mr-2"></i>
                <span class="text-sm text-gray-700">Değerlendirilen Personel: <span class="font-semibold text-green-700">${escapeHtml(rating.selectedPersonnel || rating.deliveryPersonnel || rating.garson)}</span></span>
              </div>
            </div>
          ` : ''}
          
          <!-- Yorum - Varsa göster -->
          ${comment ? `
            <div class="bg-gray-50 rounded-lg p-4 mb-3">
              <div class="flex items-center mb-2">
                <i class="fas fa-comment text-gray-600 mr-2"></i>
                <h4 class="font-semibold text-gray-800">Yorum:</h4>
              </div>
              <p class="text-gray-700 ml-6">${escapeHtml(comment)}</p>
            </div>
          ` : ''}
            
            ${orderContent ? `
              <div class="bg-blue-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center">
                    <i class="fas fa-shopping-cart text-blue-600 mr-2"></i>
                    <h4 class="font-semibold text-blue-800">Sipariş İçeriği:</h4>
                  </div>
                  <button 
                    onclick="toggleOrderContent('${rating.id}')" 
                    class="text-blue-600 hover:text-blue-800 p-1 rounded transition-all duration-200"
                    title="Sipariş içeriğini göster/gizle"
                    id="toggle-btn-${rating.id}"
                  >
                    <i class="fas fa-chevron-down" id="toggle-icon-${rating.id}"></i>
                  </button>
                </div>
                <div class="text-sm text-gray-700 ml-6 order-content" id="order-content-${rating.id}" style="display: none;">
                  ${orderContent}
                  ${(typeof rating.toplamFiyat !== 'undefined' && rating.toplamFiyat !== null) ? `
                    <div class="mt-2 font-bold text-blue-800">
                      Toplam: ${escapeHtml((rating.toplamFiyat || 0).toString())} ₺
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}
          `;
          
          ratingsListDiv.appendChild(ratingCard);
        }
      }
      
      // Badge sayılarını güncelle - Sadece o kat grubunun siparişlerini say
    async function updateBadges() {
      // Kat grubuna göre siparişleri filtrele
      let filteredOrders = filterOrdersByPanel(allOrders);
      
      const preparingCount = filteredOrders.filter(order => 
        order.status === "hazırlanıyor" && order.status !== "silindi"
      ).length;
      const deliveredCount = filteredOrders.filter(order => 
        order.status === "teslim edildi" && order.status !== "silindi"
      ).length;
      
      // Normal siparişlerden puanlama sayısı
      let ratingsCount = filteredOrders.filter(order => 
        order.rating && order.rating > 0
      ).length;
      
      // Korunan puanlamalardan da say
      try {
        const preservedSnapshot = await getDocs(collection(db, "preserved_ratings"));
        const preservedRatings = preservedSnapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(rating => {
            const floor = Number(rating.userFloor);
            if (activeFloorGroup === 'z123') {
              return floor >= 1 && floor <= 3;
            } else if (activeFloorGroup === '456') {
              return floor >= 4 && floor <= 6;
            } else if (activeFloorGroup === '78910') {
              return floor >= 7 && floor <= 10;
            }
            return false;
          });
        
        ratingsCount += preservedRatings.length;
      } catch (error) {
        console.error('Korunan değerlendirmeler sayılırken hata:', error);
      }
      
      // Badge elementlerinin varlığını kontrol et
      if (preparingBadge) {
        // Eğer notification timeout aktifse, badge'i değiştirme
        if (!notificationTimeoutId) {
          preparingBadge.classList.toggle('hidden', preparingCount === 0);
        }
        
        // Hazırlanan sipariş sayısını güncelle
        const preparingCountElement = document.getElementById('preparing-count');
        if (preparingCountElement) {
          preparingCountElement.textContent = preparingCount;
        }
      }
      if (deliveredBadge) {
        deliveredBadge.textContent = deliveredCount;
        deliveredBadge.classList.toggle('hidden', deliveredCount === 0);
      }
      if (ratingsBadge) {
        ratingsBadge.textContent = ratingsCount;
        ratingsBadge.classList.toggle('hidden', ratingsCount === 0);
      }
    }
    // Siparişleri Firestore'dan çek
    const q = query(collection(db, "siparisler"), orderBy("tarih", "desc"));
    let lastOrderIds = [];
    let lastOrderCount = 0;
    
    onSnapshot(q, (snapshot) => {
      // Sadece bu panele ait siparişleri filtrele
      const panelOrders = snapshot.docs.filter(docSnap => {
        const order = docSnap.data();
        const floor = Number(order.floor);
        return floor >= 7 && floor <= 10;
      });
      
      const currentOrderIds = panelOrders.map(docSnap => docSnap.id);
      const currentOrderCount = currentOrderIds.length;
      
      // Yeni sipariş geldiyse çan sesi çal ve yanıp sönen buton başlat
      if (lastOrderIds.length > 0 && currentOrderCount > lastOrderCount) {
        // Yeni sipariş ID'lerini kaydet
        panelOrders.forEach(docSnap => {
          if (!lastOrderIds.includes(docSnap.id)) {
            newOrderIds.add(docSnap.id);
          }
        });
        
        if (newOrderIds.size > 0) {
          // Ses çal ve bildirim işaretini göster
          playBellSound();
          showNotificationAlert();
        }
      }
      
      lastOrderIds = currentOrderIds;
      lastOrderCount = currentOrderCount;
      allOrders = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
      renderFloors();
      updateBadges();
      
      // Siparişler değiştiğinde rating'leri de güncelle
      if (activeTab === 'ratings') {
        loadRatings();
      }
    });
    // Personel sistemi
    const personelCollectionName = 'personel_78910'; // Kat 7-8-9-10 için
    
    // Personel listesini yükle
    async function loadPersonelList() {
      try {
        const q = query(collection(db, personelCollectionName));
        const querySnapshot = await getDocs(q);
        const personelList = document.getElementById('personel-list');
        
        if (querySnapshot.empty) {
          personelList.innerHTML = `
            <div class="flex flex-col items-center justify-center text-gray-400 py-8">
              <i class="fas fa-users text-4xl mb-2"></i>
              <div>Henüz personel eklenmemiş</div>
            </div>
          `;
          return;
        }
        
        let personelHTML = '';
        querySnapshot.forEach((doc) => {
          const personel = doc.data();
          personelHTML += `
            <div class="flex justify-between items-center py-2 border-b border-gray-200 w-full">
              <div class="flex-1 text-left">
                <div class="font-medium text-gray-800">${personel.ad} ${personel.soyad}</div>
                <div class="text-sm text-gray-500">${personel.tel || 'Telefon yok'}</div>
              </div>
              <button onclick="deletePersonel('${doc.id}')" class="text-red-500 hover:text-red-700 p-1">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
        });
        
        personelList.innerHTML = personelHTML;
      } catch (error) {
        console.error('Personel listesi yüklenirken hata:', error);
      }
    }
    
    // Personel ekle
    async function addPersonel(event) {
      event.preventDefault();
      
      const ad = document.getElementById('personel-ad').value.trim();
      const soyad = document.getElementById('personel-soyad').value.trim();
      const tel = document.getElementById('personel-tel').value.trim();
      
      if (!ad || !soyad) {
        alert('Ad ve soyad alanları zorunludur!');
        return;
      }
      
      try {
        await addDoc(collection(db, personelCollectionName), {
          ad: ad,
          soyad: soyad,
          tel: tel,
          eklenmeTarihi: Timestamp.now()
        });
        
        document.getElementById('add-personel-form').reset();
        // Kısa bir gecikme ekleyerek listeyi yeniden yükle
        setTimeout(async () => {
          await loadPersonelList();
        }, 100);
        
        // Modal'ı kapat
        document.getElementById('personel-modal').style.display = 'none';
        
        // Başarı bildirimi göster
        await showAlert(`${ad} ${soyad} başarıyla eklendi!`, 'success');
      } catch (error) {
        console.error('Personel eklenirken hata:', error);
        
        // Hata bildirimi göster
        await showAlert('Personel eklenirken bir hata oluştu!', 'error');
      }
    }
    
    // Personel sil
    window.deletePersonel = async function(personelId) {
      if (!confirm('Bu personeli silmek istediğinizden emin misiniz?')) return;
      try {
        await deleteDoc(doc(db, personelCollectionName, personelId));
        // Kısa bir gecikme ekleyerek listeyi yeniden yükle
        setTimeout(async () => {
          await loadPersonelList();
        }, 100);
      } catch (error) {
        console.error('Personel silinirken hata:', error);
        alert('Personel silinirken bir hata oluştu!');
      }
    }
    
    // Personel modal olay dinleyicileri
    document.getElementById('open-personel-btn').addEventListener('click', () => {
      document.getElementById('personel-modal').style.display = 'flex';
      // Modal açıldığında listeyi yeniden yükle
      setTimeout(async () => {
        await loadPersonelList();
      }, 100);
    });
    
    document.getElementById('close-personel-btn').addEventListener('click', () => {
      document.getElementById('personel-modal').style.display = 'none';
    });
    
    document.getElementById('add-personel-form').addEventListener('submit', addPersonel);
    
    // Menü modal olay dinleyicileri
    document.getElementById('open-menu-btn').addEventListener('click', () => {
      document.getElementById('menu-modal').style.display = 'flex';
    });
    
    document.getElementById('close-menu-btn').addEventListener('click', () => {
      document.getElementById('menu-modal').style.display = 'none';
    });
    
    // Sayfa yüklendiğinde
    window.addEventListener('DOMContentLoaded', () => {
      listenMenuRealtime();
      setActiveTab('preparing'); // Varsayılan olarak preparing sekmesini aktif et
    });

    // 10 dakikalık kontrol sistemi
    let lastOrderUpdate = Date.now();
    
    // 10 dakikada bir kontrol et
    setInterval(() => {
      const now = Date.now();
      if (now - lastOrderUpdate > 10 * 60 * 1000) { // 10 dakika
        // Hazırlananlar sekmesinde değilse ve hazırlanacak sipariş varsa
        if (activeTab !== 'preparing' && allOrders.some(order => {
          const floor = Number(order.floor);
          let isInPanel = false;
          if (activeFloorGroup === 'z123') {
            isInPanel = floor >= 1 && floor <= 3;
          } else if (activeFloorGroup === '456') {
            isInPanel = floor >= 4 && floor <= 6;
          } else if (activeFloorGroup === '78910') {
            isInPanel = floor >= 7 && floor <= 10;
          }
          return isInPanel && order.status !== 'teslim edildi';
        })) {
          // Ses çal ve yanıp sönen buton başlat
          playBellSound();
          startBlinking();
          lastOrderUpdate = now;
        }
      }
    }, 60 * 1000); // Her dakika kontrol et

    // Kat Bazlı Satış Raporu Modalı Aç/Kapat
    const openFloorReportBtn = document.getElementById('open-floor-report-btn');
    const floorReportModal = document.getElementById('floor-report-modal');
    const closeFloorReportBtn = document.getElementById('close-floor-report-btn');
    const floorSalesTable = document.getElementById('floor-sales-table');

    openFloorReportBtn.addEventListener('click', () => {
      updateFloorSalesReport();
      updateFloorButtonStyles(); // Buton stillerini güncelle
      floorReportModal.style.display = 'flex';
      document.body.classList.add('modal-open');
    });
    
    // Kat raporu periyot butonları
    const floorDailyBtn = document.getElementById('floor-daily-btn');
    const floorWeeklyBtn = document.getElementById('floor-weekly-btn');
    const floorMonthlyBtn = document.getElementById('floor-monthly-btn');
    
    floorDailyBtn.addEventListener('click', () => {
      activeFloorReportPeriod = 'daily';
      updateFloorButtonStyles();
      updateFloorSalesReport();
    });
    
    floorWeeklyBtn.addEventListener('click', () => {
      activeFloorReportPeriod = 'weekly';
      updateFloorButtonStyles();
      updateFloorSalesReport();
    });
    
    floorMonthlyBtn.addEventListener('click', () => {
      activeFloorReportPeriod = 'monthly';
      updateFloorButtonStyles();
      updateFloorSalesReport();
    });
    
    // Kat raporu buton stillerini güncelle
    function updateFloorButtonStyles() {
      // Tüm butonları varsayılan stile getir
      floorDailyBtn.className = 'bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300';
      floorWeeklyBtn.className = 'bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300';
      floorMonthlyBtn.className = 'bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300';
      
      // Aktif butonu vurgula
      switch (activeFloorReportPeriod) {
        case 'daily':
          floorDailyBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300';
          break;
        case 'weekly':
          floorWeeklyBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300';
          break;
        case 'monthly':
          floorMonthlyBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300';
          break;
      }
    }
    
    closeFloorReportBtn.addEventListener('click', () => {
      floorReportModal.style.display = 'none';
      document.body.classList.remove('modal-open');
    });

    // Kat Bazlı Satış Raporu Hesaplama
    async function updateFloorSalesReport() {
      console.log('Kat bazlı satış raporu güncelleniyor...');
      
      try {
        // Otomatik sıfırlama kontrolü
        await checkFloorAutoReset();
        
        // Firestore'dan kat raporu verilerini al
        const floorReportRef = doc(db, "kat_raporlari", activeFloorGroup);
        const floorReportDoc = await getDoc(floorReportRef);
        
        let floorSales = {};
        if (floorReportDoc.exists()) {
          const data = floorReportDoc.data();
          
          // Aktif periyoda göre verileri seç
          switch (activeFloorReportPeriod) {
            case 'daily':
              floorSales = data.floorDailySales || {};
              break;
            case 'weekly':
              floorSales = data.floorWeeklySales || {};
              break;
            case 'monthly':
              floorSales = data.floorMonthlySales || {};
              break;
            default:
              floorSales = data.floorSales || {}; // Kalıcı veriler
          }
        }
        
        // Tabloyu güncelle
        if (floorSalesTable) {
          let tableHTML = `
            <thead>
              <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left">Kat</th>
                <th class="px-4 py-2 text-left">Sipariş Sayısı</th>
                <th class="px-4 py-2 text-left">Toplam Satış</th>
                <th class="px-4 py-2 text-left">Detay</th>
              </tr>
            </thead>
            <tbody>
          `;
          
          if (Object.keys(floorSales).length === 0) {
            tableHTML += `
              <tr class="border-b">
                <td class="px-4 py-2 border border-gray-300 text-center text-gray-500" colspan="4">
                  ${activeFloorReportPeriod === 'daily' ? 'Günlük' : activeFloorReportPeriod === 'weekly' ? 'Haftalık' : 'Aylık'} veri bulunamadı
                </td>
              </tr>
            `;
          } else {
          Object.keys(floorSales).sort((a, b) => Number(a) - Number(b)).forEach(floor => {
            const data = floorSales[floor];
              const floorName = floor === '0' ? 'Zemin' : `Kat ${floor}`;
            
            tableHTML += `
              <tr class="border-b hover:bg-gray-50 cursor-pointer floor-row" data-floor="${floor}" data-floor-name="${floorName}">
                <td class="px-4 py-2 font-medium">${floorName}</td>
                  <td class="px-4 py-2">${data.count || 0}</td>
                  <td class="px-4 py-2 font-bold text-green-600">${(data.total || 0).toFixed(2)} ₺</td>
                <td class="px-4 py-2 text-blue-600 hover:text-blue-800">
                  <i class="fas fa-eye"></i> Detay
                </td>
              </tr>
            `;
          });
          }
          
          tableHTML += '</tbody>';
          floorSalesTable.innerHTML = tableHTML;
          
          // Kat satırlarına tıklama olayı ekle
          document.querySelectorAll('.floor-row').forEach(row => {
            row.addEventListener('click', () => {
              const floor = row.getAttribute('data-floor');
              const floorName = row.getAttribute('data-floor-name');
              showFloorDetail(floor, floorName, floorSales[floor]);
            });
          });
        }
      } catch (error) {
        console.error('Kat raporu güncellenirken hata:', error);
      }
    }

    // Kat raporu temizleme fonksiyonu
    async function resetFloorReport() {
      try {
        const confirmed = await showConfirm('Kat Raporunu Temizle', 'Kat raporu verilerini sıfırlamak istediğinizden emin misiniz?', 'danger');
        if (confirmed) {
          const floorReportRef = doc(db, "kat_raporlari", activeFloorGroup);
          await setDoc(floorReportRef, {
            floorSales: {},
            lastUpdated: new Date(),
            floorGroup: activeFloorGroup
          });
          
                    // Tabloyu temizle
          if (floorSalesTable) {
            floorSalesTable.innerHTML = `
              <thead>
                <tr class="bg-gray-100">
                  <th class="px-4 py-2 text-left">Kat</th>
                  <th class="px-4 py-2 text-left">Sipariş Sayısı</th>
                <th class="px-4 py-2 text-left">Toplam Satış</th>
                  <th class="px-4 py-2 text-left">En Popüler Ürün</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b">
                <td class="px-4 py-2 border border-gray-300 text-center text-gray-500" colspan="4">Veri yok</td>
              </tr>
            </tbody>
          `;
        }
        
        // Rapor kısmını da temizle (aynı veri kaynağını kullandığı için)
        const raporRef = doc(db, "raporlar", activeFloorGroup);
        await setDoc(raporRef, {
          kaliciToplam: 0,
          eklenenSiparisler: [],
          lastUpdated: new Date(),
          floorGroup: activeFloorGroup
        });
        
      }
    } catch (error) {
      console.error('Kat raporu temizlenirken hata:', error);
      await showAlert('Kat raporu temizlenirken bir hata oluştu!', 'error');
    }
  }

    // Kat detay modal'ını göster
    function showFloorDetail(floor, floorName, floorData) {
      const modal = document.getElementById('floor-detail-modal');
      const content = document.getElementById('floor-detail-content');
      const title = document.getElementById('floor-detail-title');
      const body = document.getElementById('floor-detail-content-body');
      
      title.textContent = `${floorName} Detay Raporu`;
      
      // Toplam çay fişi hesapla
      let totalTickets = 0;
      if (floorData.items) {
        Object.values(floorData.items).forEach(itemData => {
          totalTickets += itemData.tickets || 0;
        });
      }
      
      let detailHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-3">Genel Bilgiler</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-gray-600">Toplam Sipariş:</span>
                <span class="font-semibold">${floorData.count || 0}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Toplam Satış:</span>
                <span class="font-semibold text-green-600">${(floorData.total || 0).toFixed(2)} ₺</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Toplam Çay Fişi:</span>
                <span class="font-semibold text-blue-600">${totalTickets}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Ortalama Sipariş:</span>
                <span class="font-semibold">${(floorData.count || 0) > 0 ? ((floorData.total || 0) / (floorData.count || 1)).toFixed(2) : '0.00'} ₺</span>
              </div>
            </div>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-3">Ürün Dağılımı</h4>
            <div class="space-y-2 max-h-48 overflow-y-auto">
      `;
      
      if (floorData.items && Object.keys(floorData.items).length > 0) {
        Object.entries(floorData.items).forEach(([itemName, itemData]) => {
          detailHTML += `
            <div class="flex justify-between items-center p-2 bg-white rounded border">
              <span class="text-gray-700">${itemName}</span>
              <div class="text-right">
                <div class="font-semibold">${itemData.quantity || 0} adet</div>
                <div class="text-sm text-green-600">${(itemData.revenue || 0).toFixed(2)} ₺</div>
                ${itemData.tickets ? `<div class="text-xs text-blue-600">${itemData.tickets} Fiş</div>` : ''}
              </div>
            </div>
          `;
        });
      } else {
        detailHTML += `
          <div class="text-gray-500 text-center py-4">
            <i class="fas fa-info-circle mr-2"></i>
            Bu kat için ürün detayı bulunmuyor
          </div>
        `;
      }
      
      detailHTML += `
            </div>
          </div>
        </div>
      `;
      
      body.innerHTML = detailHTML;
      
      // Modal'ı göster
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
    
    // Kat detay modal'ını kapat
    function closeFloorDetail() {
      const modal = document.getElementById('floor-detail-modal');
      const content = document.getElementById('floor-detail-content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }
    
    // Kat detay modal kapatma butonu
    document.getElementById('close-floor-detail-btn').addEventListener('click', closeFloorDetail);
    
    // Modal dışına tıklayınca kapat
    document.getElementById('floor-detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'floor-detail-modal') {
        closeFloorDetail();
      }
    });

    // Kat raporu temizleme butonu olay dinleyicisi
    document.getElementById('reset-floor-report-btn').addEventListener('click', resetFloorReport);

  </script>
  
</body>
</html>