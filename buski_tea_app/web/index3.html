<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buski Çay Ocağı Sipariş Paneli</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #16a34a;
      --warning-color: #f59e0b;
      --danger-color: #dc2626;
      --error-color: #9d17d2; /* Mor renk */
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    .header-gradient {
      background: linear-gradient(90deg, var(--primary-color) 0%, #1d4ed8 100%);
    }
    .tab-active {
      background-color: white;
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      font-weight: 600;
    }
    .tab-inactive {
      color: #94a3b8;
      border-bottom: 3px solid transparent;
    }
    .tab-inactive:hover {
      color: #64748b;
      background-color: rgba(255, 255, 255, 0.7);
    }
    .floor-card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .floor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .order-card {
      background: #f8fafc;
      border-radius: 10px;
      border-left: 4px solid #cbd5e1;
      transition: all 0.3s ease;
    }
    .order-card-preparing {
      border-left-color: var(--warning-color);
    }
    .order-card-ready {
      border-left-color: var(--secondary-color);
      background-color: #f0fdf4;
    }
    .order-card-delivered {
      border-left-color: #94a3b8;
      background-color: #f1f5f9;
    }
    .status-btn {
      transition: all 0.2s ease;
      font-weight: 500;
      border-radius: 6px;
    }
    .btn-preparing {
      background-color: var(--warning-color);
      color: white;
    }
    .btn-preparing:hover:not(:disabled) {
      background-color: #d97706;
    }
    .btn-ready {
      background-color: var(--secondary-color);
      color: white;
    }
    .btn-ready:hover:not(:disabled) {
      background-color: #15803d;
    }
    .btn-delivered {
      background-color: #94a3b8;
      color: white;
      cursor: not-allowed;
    }
    .btn-delete {
      background-color: var(--danger-color);
      color: white;
    }
    .btn-delete:hover {
      background-color: #b91c1c;
    }
    .btn-error {
      background-color: var(--error-color);
      color: white;
    }
    .btn-error:hover {
      background-color: #7e1bb0;
    }
    .empty-state {
      color: #94a3b8;
    }
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -8px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 10;
    }
    .floor-group-btn {
      background-color: #e2e8f0;
      color: #475569;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 8px 16px;
      margin: 0 4px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .floor-group-btn:hover {
      background-color: #cbd5e1;
    }
    .floor-group-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .fade-out {
      animation: fadeShrink 0.6s forwards;
    }
    @keyframes fadeShrink {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }
    .center-message {
      text-align: center;
      font-weight: 600;
      color: #065f46;
      margin: 8px 0;
      width: 100%;
    }
    /* Modal stilleri */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      max-height: 85vh;
      overflow-y: auto;
      width: 95%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .menu-item {
      border-bottom: 1px solid #e2e8f0;
      padding: 12px 0;
    }
    .menu-item:last-child {
      border-bottom: none;
    }
    .add-product-card {
      background-color: #f1f5f9;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px dashed #cbd5e1;
    }
    .add-product-card:hover {
      background-color: #e2e8f0;
      border-color: #94a3b8;
    }
    .form-input {
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 10px 12px;
      transition: border-color 0.2s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .form-submit-btn {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .form-submit-btn:hover {
      background-color: #1d4ed8;
    }
    .form-delete-btn {
      background-color: var(--danger-color);
      color: white;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .form-delete-btn:hover {
      background-color: #b91c1c;
    }
    .scroll-container {
      max-height: 60vh;
      overflow-y: auto;
    }
    /* Scrollbar stilleri */
    .scroll-container::-webkit-scrollbar {
      width: 8px;
    }
    .scroll-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .scroll-container::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
    }
    .scroll-container::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
    .floor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .order-list {
      flex-grow: 1;
      overflow-y: auto;
      max-height: 350px;
      padding: 0.5rem;
    }
    @media (max-width: 768px) {
      .floor-grid {
        grid-template-columns: 1fr;
      }
      .floor-card {
        min-width: 100%;
      }
      .floor-group-btn {
        margin: 2px;
        padding: 6px 12px;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Menü Açma Butonu -->
  <button id="open-menu-btn" class="fixed top-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium">
    MENU
  </button>
  <!-- Menü Modal -->
  <div id="menu-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Menü</h2>
        <button id="close-menu-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <div id="menu-list" class="p-4 scroll-container"></div>
    </div>
  </div>
  <!-- Yeni Ürün Ekle Modal -->
  <div id="add-product-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Yeni Ürün Ekle</h2>
        <button id="close-add-product-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <form id="add-product-form" class="p-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
          <input type="text" name="product-name" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺)</label>
          <input type="number" name="product-price" step="0.01" min="0" class="form-input w-full" required>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Opsiyonlar (Virgülle ayırın)</label>
          <input type="text" name="product-options" placeholder="Örn: Sade, Şekerli, Limonlu" class="form-input w-full">
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="add-product-instock" name="product-instock" class="mr-2" checked>
            <span class="text-sm font-medium text-gray-700">Stokta mevcut</span>
          </label>
        </div>
        <div class="text-center">
          <button type="submit" class="form-submit-btn px-6 py-2">Ürünü Ekle</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Ürün Düzenle Modal -->
  <div id="edit-product-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Ürünü Düzenle</h2>
        <button id="close-edit-product-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <form id="edit-product-form" class="p-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
          <input type="text" id="edit-product-name" name="edit-product-name" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺)</label>
          <input type="number" id="edit-product-price" name="edit-product-price" step="0.01" min="0" class="form-input w-full" required>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Opsiyonlar (Virgülle ayırın)</label>
          <input type="text" id="edit-product-options" name="edit-product-options" placeholder="Örn: Sade, Şekerli, Limonlu" class="form-input w-full">
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="edit-product-instock" name="edit-product-instock" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Stokta mevcut</span>
          </label>
        </div>
        <div class="flex justify-between">
          <button type="submit" class="form-submit-btn px-6 py-2">Güncelle</button>
          <button type="button" id="delete-product-btn" class="form-delete-btn px-6 py-2">Sil</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Rapor Butonu -->
<button id="open-report-btn" class="fixed top-16 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium">
  Rapor
</button>
<!-- Rapor Modal -->
<div id="report-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold text-gray-800">Satış Raporu</h2>
      <button id="close-report-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>
    <div id="report-content" class="p-6">
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Tarih: <span id="report-date"></span></h3>
      </div>
      <div class="space-y-4">
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Günlük Toplam Satış</span>
            <span id="daily-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Haftalık Toplam Satış</span>
            <span id="weekly-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Aylık Toplam Satış</span>
            <span id="monthly-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>
  <!-- Bildirim Sesi -->
  <audio id="order-notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
  <!-- Ana İçerik -->
  <header class="header-gradient text-white py-6 px-4 shadow-lg">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold flex items-center justify-center">
        <i class="fas fa-mug-hot mr-3"></i>
        Çay Ocağı Sipariş Paneli
      </h1>
      <p class="mt-2 opacity-90 text-center">Siparişleri takip edin ve durumlarını güncelleyin</p>
    </div>
  </header>
  <main class="container mx-auto px-4 py-6">
    <!-- Sekmeler -->
    <div class="flex justify-center border-b border-gray-200 mb-6 relative">
      <button id="preparing-tab" class="tab-active px-6 py-3 text-lg relative">
        Hazırlananlar
        <span id="preparing-badge" class="notification-badge hidden">0</span>
      </button>
      <button id="delivered-tab" class="tab-inactive px-6 py-3 text-lg relative">
        Teslim Edilenler
        <span id="delivered-badge" class="notification-badge hidden">0</span>
      </button>
    </div>
    
    <!-- Kat Grubu Seçimi Butonları -->
    <div class="flex flex-wrap justify-center mb-6">
      <button class="floor-group-btn active" data-group="78910">Kat 7-8-9-10</button>
    </div>
    
    <!-- Katlar -->
    <div id="floors-container"></div>
  </main>
  <script type="module">
    // Rapor modal elemanları
const reportModal = document.getElementById('report-modal');
const openReportBtn = document.getElementById('open-report-btn');
const closeReportBtn = document.getElementById('close-report-btn');
const reportDate = document.getElementById('report-date');
const dailyTotal = document.getElementById('daily-total');
const weeklyTotal = document.getElementById('weekly-total');
const monthlyTotal = document.getElementById('monthly-total');

// Rapor modal olay dinleyicileri
openReportBtn.addEventListener('click', () => {
  updateReport();
  reportModal.style.display = 'flex';
});
closeReportBtn.addEventListener('click', () => {
  reportModal.style.display = 'none';
});

// Rapor hesaplama fonksiyonları
function calculateDailyTotal(orders, date) {
  return orders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate.getFullYear() === date.getFullYear() &&
           orderDate.getMonth() === date.getMonth() &&
           orderDate.getDate() === date.getDate();
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function calculateWeeklyTotal(orders, date) {
  const startOfWeek = new Date(date);
  startOfWeek.setDate(date.getDate() - date.getDay() + 1);
  startOfWeek.setHours(0, 0, 0, 0);

  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  endOfWeek.setHours(23, 59, 59, 999);

  return orders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate >= startOfWeek && orderDate <= endOfWeek;
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function calculateMonthlyTotal(orders, date) {
  return orders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate.getFullYear() === date.getFullYear() &&
           orderDate.getMonth() === date.getMonth();
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function updateReport() {
  const now = new Date();
  const dailyTotalValue = calculateDailyTotal(allOrders, now);
  const weeklyTotalValue = calculateWeeklyTotal(allOrders, now);
  const monthlyTotalValue = calculateMonthlyTotal(allOrders, now);

  // Tarih formatla
  reportDate.textContent = now.toLocaleDateString('tr-TR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });

  // Toplamları güncelle
  dailyTotal.textContent = dailyTotalValue.toFixed(2) + ' ₺';
  weeklyTotal.textContent = weeklyTotalValue.toFixed(2) + ' ₺';
  monthlyTotal.textContent = monthlyTotalValue.toFixed(2) + ' ₺';
}
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy,
      onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCxtk5JjQiidKZtqOo0QvewUBK0W3TH2xk",
      authDomain: "buski-1b341.firebaseapp.com",
      projectId: "buski-1b341",
      storageBucket: "buski-1b341.firebasestorage.app",
      messagingSenderId: "463802150330",
      appId: "1:463802150330:web:02d0ada7954afb51658183",
      measurementId: "G-V072X4G0BM"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Menü verisi
    const defaultMenu = [
      {
        name: 'Çay',
        price: 2,
        options: ['Şekersiz', 'Şekerli'],
        defaultOption: 'Şekersiz',
      },
      {
        name: 'Çay (Su Bardağı)',
        price: 4,
        options: ['Şekersiz', 'Şekerli'],
        defaultOption: 'Şekersiz',
      },
      {
        name: 'Bitki Çayı',
        price: 2,
        options: ['Çiçek', 'Adaçayı', 'Kuşburnu'],
        defaultOption: 'Çiçek',
      },
      {
        name: 'Oralet',
        price: 2,
        options: ['Şekersiz', 'Şekerli'],
        defaultOption: 'Şekersiz',
      },
      {
        name: 'Nescafe',
        price: 8,
        options: ['Sade', 'Sütlü'],
        defaultOption: 'Sade',
      },
      {
        name: 'Türk Kahvesi',
        price: 10,
        options: ['Sade', 'Orta', 'Şekerli'],
        defaultOption: 'Sade',
      },
      {
        name: 'Maden Suyu',
        price: 10,
        options: ['Sade', 'Elmalı', 'Limonlu', 'Narlı'],
        defaultOption: 'Sade',
      },
      { name: 'Sade Gazoz', price: 30, options: [], defaultOption: '' },
      { name: 'Sarı Gazoz', price: 34, options: [], defaultOption: '' },
      {
        name: "Çay Fişi 100'lü",
        price: 200,
        options: [],
        defaultOption: '',
      },
    ];
    let menuData = [];
    let allOrders = [];
    let activeTab = 'preparing'; // 'preparing' veya 'delivered'
    let activeFloorGroup = '78910'; // Sadece kat 7-8-9-10
    // DOM Elemanları
    const menuModal = document.getElementById('menu-modal');
    const menuListContainer = document.getElementById('menu-list');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const openMenuBtn = document.getElementById('open-menu-btn');
    const addProductModal = document.getElementById('add-product-modal');
    const closeAddProductBtn = document.getElementById('close-add-product-btn');
    const addProductForm = document.getElementById('add-product-form');
    const editProductModal = document.getElementById('edit-product-modal');
    const closeEditProductBtn = document.getElementById('close-edit-product-btn');
    const editProductForm = document.getElementById('edit-product-form');
    const editProductNameInput = document.getElementById('edit-product-name');
    const editProductPriceInput = document.getElementById('edit-product-price');
    const editProductOptionsInput = document.getElementById('edit-product-options');
    const addProductInStockInput = document.getElementById('add-product-instock');
    const editProductInStockInput = document.getElementById('edit-product-instock');
    const preparingTab = document.getElementById('preparing-tab');
    const deliveredTab = document.getElementById('delivered-tab');
    const floorsContainer = document.getElementById('floors-container');
    const preparingBadge = document.getElementById('preparing-badge');
    const deliveredBadge = document.getElementById('delivered-badge');
    const floorGroupButtons = document.querySelectorAll('.floor-group-btn');
    let editingProductIndex = -1;
    // Modal olay dinleyicileri
    openMenuBtn.addEventListener('click', () => {
      renderMenuList();
      menuModal.style.display = 'flex';
    });
    closeMenuBtn.addEventListener('click', () => {
      menuModal.style.display = 'none';
    });
    closeAddProductBtn.addEventListener('click', () => {
      addProductModal.style.display = 'none';
    });
    closeEditProductBtn.addEventListener('click', () => {
      editProductModal.style.display = 'none';
    });
    // Sekme değişiklikleri
    preparingTab.addEventListener('click', () => {
      setActiveTab('preparing');
    });
    deliveredTab.addEventListener('click', () => {
      setActiveTab('delivered');
    });
    // Kat grubu değişiklikleri - Sadece kat 7-8-9-10
    // Bu panel sadece kat 7-8-9-10 için olduğundan değişiklik yok
    // Menü listesini render et
    function renderMenuList() {
      menuListContainer.innerHTML = '';
      menuData.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'menu-item';
        const inStock = item.inStock !== false; // Varsayılan true
        row.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-gray-800">${escapeHtml(item.name)}</div>
              <div class="text-gray-600 mt-1">${item.price} ₺</div>
              <div class="text-gray-500 text-sm mt-1">${item.options && item.options.length ? 'Opsiyonlar: ' + escapeHtml(item.options.join(', ')) : 'Opsiyon yok'}</div>
            </div>
            <div class="flex items-center gap-2">
              <button
                class="text-blue-600 hover:text-blue-800 p-2"
                title="Düzenle"
                data-idx="${idx}"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="text-gray-500 hover:text-gray-700 p-2"
                title="Stok Durumu"
                data-stock-idx="${idx}"
              >
                <i class="fas ${inStock ? 'fa-eye' : 'fa-eye-slash'}"></i>
              </button>
            </div>
          </div>
        `;
        const editButton = row.querySelector('button[data-idx]');
        editButton.addEventListener('click', (e) => {
          editingProductIndex = Number(e.currentTarget.getAttribute('data-idx'));
          const productToEdit = menuData[editingProductIndex];
          editProductNameInput.value = productToEdit.name;
          editProductPriceInput.value = productToEdit.price;
          editProductOptionsInput.value = productToEdit.options.join(', ');
          // Stok durumu checkbox'ı
          if (editProductInStockInput) {
            editProductInStockInput.checked = productToEdit.inStock !== false;
          }
          editProductModal.style.display = 'flex';
        });
        // Göz (stok) butonu
        const stockButton = row.querySelector('button[data-stock-idx]');
        stockButton.addEventListener('click', async (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-stock-idx'));
          menuData[idx].inStock = !(menuData[idx].inStock !== false);
          await saveMenuToFirestore();
          renderMenuList();
        });
        menuListContainer.appendChild(row);
      });
      const addProductCard = document.createElement('div');
      addProductCard.className = 'add-product-card mt-2';
      addProductCard.innerHTML = `
        <i class="fas fa-plus-circle text-2xl text-gray-400 mb-2"></i>
        <div class="text-gray-600 font-medium">Yeni Ürün Ekle</div>
      `;
      addProductCard.addEventListener('click', () => {
        addProductModal.style.display = 'flex';
      });
      menuListContainer.appendChild(addProductCard);
    }
    // Yardımcı fonksiyon: HTML kaçış
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
    // Yeni ürün ekleme form submit
    addProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(addProductForm);
      const name = formData.get('product-name').trim();
      const price = parseFloat(formData.get('product-price'));
      const optionsText = formData.get('product-options').trim();
      if (!name || isNaN(price) || price < 0) {
        alert('Lütfen geçerli ürün adı ve fiyat giriniz.');
        return;
      }
      const options = optionsText ? optionsText.split(',').map(opt => opt.trim()).filter(opt => opt) : [];
      const defaultOption = options.length > 0 ? options[0] : '';
      const newProduct = {
        name: name,
        price: price,
        options: options,
        defaultOption: defaultOption,
        inStock: addProductInStockInput.checked
      };
      menuData.push(newProduct);
      await saveMenuToFirestore();
      addProductModal.style.display = 'none';
      addProductForm.reset();
      renderMenuList();
    });
    // Ürün düzenleme form submit
    editProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editProductForm);
      const name = formData.get('edit-product-name').trim();
      const price = parseFloat(formData.get('edit-product-price'));
      const optionsText = formData.get('edit-product-options').trim();
      if (!name || isNaN(price) || price < 0) {
        alert('Lütfen geçerli ürün adı ve fiyat giriniz.');
        return;
      }
      const options = optionsText ? optionsText.split(',').map(opt => opt.trim()).filter(opt => opt) : [];
      const defaultOption = options.length > 0 ? options[0] : '';
      if (editingProductIndex !== -1) {
        menuData[editingProductIndex] = {
          name: name,
          price: price,
          options: options,
          defaultOption: defaultOption,
          inStock: editProductInStockInput.checked
        };
        await saveMenuToFirestore();
      }
      editProductModal.style.display = 'none';
      renderMenuList();
    });
    // Ürün silme
    document.getElementById('delete-product-btn').addEventListener('click', async () => {
      if (editingProductIndex !== -1) {
        if (confirm('Bu ürünü silmek istediğinizden emin misiniz?')) {
          menuData.splice(editingProductIndex, 1);
          await saveMenuToFirestore();
          editProductModal.style.display = 'none';
          renderMenuList();
        }
      }
    });
    // Firestore'dan menüyü oku - Kat 7-8-9-10 için
    async function fetchMenuFromFirestore() {
      const menuDocRef = doc(db, "menu", "kat78910");
      const menuDoc = await getDoc(menuDocRef);
      if (menuDoc.exists()) {
        menuData = menuDoc.data().items || [];
      } else {
        menuData = [...defaultMenu];
        await setDoc(menuDocRef, { items: menuData });
      }
      renderMenuList();
    }
    // Firestore'a menüyü kaydet - Kat 7-8-9-10 için
    async function saveMenuToFirestore() {
      const menuDocRef = doc(db, "menu", "kat78910");
      await setDoc(menuDocRef, { items: menuData });
    }
    // Firestore'daki menüde değişiklikleri dinle - Kat 7-8-9-10 için
    function listenMenuRealtime() {
      const menuDocRef = doc(db, "menu", "kat78910");
      onSnapshot(menuDocRef, (docSnap) => {
        if (docSnap.exists()) {
          menuData = docSnap.data().items || [];
          renderMenuList();
        }
      });
    }
    // Sekme değiştirme
    function setActiveTab(tab) {
      activeTab = tab;
      if (tab === 'preparing') {
        preparingTab.classList.add('tab-active');
        preparingTab.classList.remove('tab-inactive');
        deliveredTab.classList.add('tab-inactive');
        deliveredTab.classList.remove('tab-active');
      } else {
        deliveredTab.classList.add('tab-active');
        deliveredTab.classList.remove('tab-inactive');
        preparingTab.classList.add('tab-inactive');
        preparingTab.classList.remove('tab-active');
      }
      renderFloors();
    }

    // Hata butonu işlevi: Siparişi hazırlananlar sekmesine geri döndürür
    window.revertToPreparing = async function(id, btn) {
        if (confirm('Bu siparişi hazırlananlar sekmesine geri almak istediğinizden emin misiniz?')) {
            const ref = doc(db, "siparisler", id);
            try {
                await updateDoc(ref, { status: "hazırlanıyor" });
                
                // Otomatik olarak "Hazırlananlar" sekmesine geç
                if (activeTab !== 'preparing') {
                    setActiveTab('preparing');
                }
                
                console.log("Sipariş durumu güncellendi:", id);
            } catch (error) {
                console.error("Hata durumu güncellenirken hata oluştu:", error);
                alert("Hata durumu güncellenirken bir sorun oluştu.");
            }
        }
    };

    // Katları render et - Sadece kat 7-8-9-10
    function renderFloors() {
      floorsContainer.innerHTML = '';
      
      const floorsToShow = [
        { floor: 7, name: 'Kat 7' },
        { floor: 8, name: 'Kat 8' },
        { floor: 9, name: 'Kat 9' },
        { floor: 10, name: 'Kat 10' }
      ];
      const groupName = "Katlar 7 - 8 - 9 - 10";
      
      const groupRow = document.createElement('div');
      groupRow.className = 'mb-8';
      groupRow.innerHTML = `<h2 class="text-xl font-bold text-center mb-4 text-gray-700">${groupName}</h2>`;
      const groupGrid = document.createElement('div');
      groupGrid.className = 'floor-grid';
      
      floorsToShow.forEach(({floor, name}) => {
        const floorCard = createFloorCard(floor, name);
        groupGrid.appendChild(floorCard);
      });
      
      groupRow.appendChild(groupGrid);
      floorsContainer.appendChild(groupRow);
    }
    // Kat kartı oluştur (floor: kat numarası, floorName: gösterilecek isim)
    function createFloorCard(floor, floorName) {
      const floorCard = document.createElement('div');
      floorCard.className = 'floor-card';
      const title = document.createElement('div');
      title.className = 'font-bold text-lg mb-4 text-center pb-2 border-b';
      title.textContent = floorName;
      floorCard.appendChild(title);
      const ordersContainer = document.createElement('div');
      ordersContainer.className = 'order-list';
      // Aktif sekmeye göre siparişleri filtrele
      let filteredOrders = [];
      if (activeTab === 'preparing') {
        filteredOrders = allOrders.filter(order => 
          Number(order.floor) === floor && 
          order.status !== "teslim edildi"
        );
      } else {
        filteredOrders = allOrders.filter(order => 
          Number(order.floor) === floor && 
          order.status === "teslim edildi"
        );
      }
      if (filteredOrders.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state text-center py-8';
        emptyState.innerHTML = `
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p class="mt-2">${activeTab === 'preparing' ? 'Hazırlanacak sipariş yok' : 'Teslim edilen sipariş yok'}</p>
        `;
        ordersContainer.appendChild(emptyState);
      } else {
        filteredOrders.forEach(order => {
          const orderCard = createOrderCard(order);
          ordersContainer.appendChild(orderCard);
        });
      }
      floorCard.appendChild(ordersContainer);
      return floorCard;
    }
    // Sipariş kartı oluştur
    function createOrderCard(order) {
      const card = document.createElement('div');
      const status = order.status || "hazırlanıyor";
      // Kart sınıfını belirle
      let cardClass = 'order-card p-4 mb-3';
      if (status === 'hazırlanıyor') {
        cardClass += ' order-card-preparing';
      } else if (status === 'hazırlandı') {
        cardClass += ' order-card-ready';
      } else if (status === 'teslim edildi') {
        cardClass += ' order-card-delivered';
      }
      card.className = cardClass;
      // Ürünler listesi
      let itemsHtml = '-';
      if (Array.isArray(order.items) && order.items.length > 0) {
        itemsHtml = order.items.map(item => 
          `${escapeHtml(item.name)}${item.option ? ' (' + escapeHtml(item.option) + ')' : ''} - ${escapeHtml(item.adet.toString())} adet`
        ).join('<br>');
      }
      // Buton metni ve sınıfı
      let buttonText = 'Hazırlanıyor...';
      let buttonClass = 'status-btn btn-preparing';
      let buttonIcon = '<i class="fas fa-spinner mr-2"></i>';
      let disabled = false;
      if (status === 'hazırlandı') {
        buttonText = 'Hazırlandı';
        buttonClass = 'status-btn btn-ready';
        buttonIcon = '<i class="fas fa-check mr-2"></i>';
      } else if (status === 'teslim edildi') {
        buttonText = 'Teslim Edildi';
        buttonClass = 'status-btn btn-delivered';
        buttonIcon = '<i class="fas fa-check-circle mr-2"></i>';
        disabled = true;
      }
      card.innerHTML = `
        <div class="grid grid-cols-1 gap-2 mb-3 text-sm">
          <div><span class="font-medium">Ad:</span> ${escapeHtml(order.ad || '')}</div>
          <div><span class="font-medium">Departman:</span> ${escapeHtml(order.departman || '')}</div>
          <div><span class="font-medium">Tarih:</span> ${order.tarih?.toDate ? escapeHtml(order.tarih.toDate().toLocaleString('tr-TR')) : ''}</div>
        </div>
        <div class="mb-3">
          <div class="font-medium mb-1">Sipariş İçeriği:</div>
          <div class="ml-3 text-sm">
            ${itemsHtml}
          </div>
          <div class="ml-3 mt-2 font-bold">
            Toplam: ${escapeHtml((order.toplamFiyat || 0).toString())} ₺
          </div>
          ${order.rating ? `
          <div class="ml-3 mt-2 flex items-center">
            <span class="text-sm text-gray-600 mr-2">Puan:</span>
            <div class="flex">
              ${Array.from({length: 5}, (_, i) => 
                `<i class="fas fa-star ${i < order.rating ? 'text-yellow-400' : 'text-gray-300'}" style="font-size: 14px;"></i>`
              ).join('')}
            </div>
            <span class="ml-2 text-sm text-gray-500">(${order.rating}/5)</span>
          </div>
          ` : ''}
        </div>
        <div class="flex justify-between items-center mt-3 pt-3 border-t">
          ${activeTab === 'preparing' ? 
            `<button class="${buttonClass} px-3 py-2 text-sm" onclick="cycleStatus('${order.id}', this)" ${disabled ? 'disabled' : ''}>
              ${buttonIcon}${buttonText}
            </button>` : 
            `<div class="flex space-x-2">
               <button class="btn-error px-3 py-2 text-sm rounded" onclick="revertToPreparing('${order.id}', this)" title="Hatalı Teslimat - Geri Al">
                 <i class="fas fa-undo mr-2"></i>Geri Al
               </button>
               <button class="btn-delete px-3 py-2 text-sm rounded" onclick="deleteOrder('${order.id}', this)">
                 <i class="fas fa-trash mr-2"></i>Sil
               </button>
             </div>`
          }
        </div>
      `;
      return card;
    }
    // Sipariş durumunu değiştir
    window.cycleStatus = async function (id, btn) {
      const ref = doc(db, "siparisler", id);
      const order = allOrders.find(o => o.id === id);
      if (!order) return;
      const currentStatus = order.status || "hazırlanıyor";
      if (currentStatus === "hazırlanıyor") {
        await updateDoc(ref, { status: "hazırlandı" });
      } else if (currentStatus === "hazırlandı") {
        const card = btn.closest('.order-card');
        if (card) {
          const msg = document.createElement('div');
          msg.className = 'center-message';
          msg.textContent = 'Teslim Edildi.';
          card.appendChild(msg);
          setTimeout(() => {
            card.classList.add('fade-out');
            setTimeout(async () => {
              await updateDoc(ref, { status: "teslim edildi" });
            }, 600);
          }, 1000);
        } else {
          await updateDoc(ref, { status: "teslim edildi" });
        }
      }
      // Badge sayılarını güncelle
      updateBadges();
    };
    // Siparişi sil
    window.deleteOrder = async function(id, btn) {
      if (confirm('Bu siparişi silmek istediğinizden emin misiniz?')) {
        const ref = doc(db, "siparisler", id);
        await deleteDoc(ref);
        const card = btn.closest('.order-card');
        if (card) {
          card.remove();
        }
        // Badge sayılarını güncelle
        updateBadges();
      }
    };
    // Bildirim sesi çal
    function playOrderNotification() {
      const audio = document.getElementById('order-notification-sound');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Ses çalınamadı:", e));
      }
    }
    // Badge sayılarını güncelle - Sadece o kat grubunun siparişlerini say
    function updateBadges() {
      // Kat grubuna göre siparişleri filtrele
      let filteredOrders = [];
      
      if (activeFloorGroup === 'z123') {
        // Zemin ve kat 1-2-3
        filteredOrders = allOrders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 0 && orderFloor <= 3;
        });
      } else if (activeFloorGroup === '456') {
        // Kat 4-5-6
        filteredOrders = allOrders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 4 && orderFloor <= 6;
        });
      } else if (activeFloorGroup === '78910') {
        // Kat 7-8-9-10
        filteredOrders = allOrders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 7 && orderFloor <= 10;
        });
      }
      
      const preparingCount = filteredOrders.filter(order => 
        order.status !== "teslim edildi"
      ).length;
      const deliveredCount = filteredOrders.filter(order => 
        order.status === "teslim edildi"
      ).length;
      
      preparingBadge.textContent = preparingCount;
      deliveredBadge.textContent = deliveredCount;
      preparingBadge.classList.toggle('hidden', preparingCount === 0);
      deliveredBadge.classList.toggle('hidden', deliveredCount === 0);
    }
    // Siparişleri Firestore'dan çek
    const q = query(collection(db, "siparisler"), orderBy("tarih", "desc"));
    let lastOrderIds = [];
    onSnapshot(q, (snapshot) => {
      const currentOrderIds = snapshot.docs.map(docSnap => docSnap.id);
      // Yeni sipariş geldiyse bildirim sesi çal
      if (lastOrderIds.length > 0 && currentOrderIds.length > lastOrderIds.length) {
        playOrderNotification();
      }
      lastOrderIds = currentOrderIds;
      allOrders = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
      renderFloors();
      updateBadges();
    });
    // Sayfa yüklendiğinde
    window.addEventListener('DOMContentLoaded', () => {
      listenMenuRealtime();
      renderFloors();
      updateBadges();
    });
  </script>
</body>
</html>