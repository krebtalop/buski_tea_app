<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buski Çay Ocağı Sipariş Paneli</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    :root {
      --primary-color: #2563eb;
      --secondary-color: #16a34a;
      --warning-color: #f59e0b;
      --danger-color: #dc2626;
      --error-color: #9d17d2; /* Mor renk */
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    .header-gradient {
      background: linear-gradient(90deg, var(--primary-color) 0%, #1d4ed8 100%);
    }
    .tab-active {
      background-color: white;
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      font-weight: 600;
    }
    .tab-inactive {
      color: #94a3b8;
      border-bottom: 3px solid transparent;
    }
    .tab-inactive:hover {
      color: #64748b;
      background-color: rgba(255, 255, 255, 0.7);
    }
    .floor-card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .floor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .order-card {
      background: #f8fafc;
      border-radius: 10px;
      border-left: 4px solid #cbd5e1;
      transition: all 0.3s ease;
    }
    .order-card-preparing {
      border-left-color: var(--warning-color);
    }
    .order-card-ready {
      border-left-color: var(--secondary-color);
      background-color: #f0fdf4;
    }
    .order-card-delivered {
      border-left-color: #94a3b8;
      background-color: #f1f5f9;
    }
    .status-btn {
      transition: all 0.2s ease;
      font-weight: 500;
      border-radius: 6px;
    }
    .btn-preparing {
      background-color: var(--warning-color);
      color: white;
    }
    .btn-preparing:hover:not(:disabled) {
      background-color: #d97706;
    }
    .btn-ready {
      background-color: var(--secondary-color);
      color: white;
    }
    .btn-ready:hover:not(:disabled) {
      background-color: #15803d;
    }
    .btn-delivered {
      background-color: #94a3b8;
      color: white;
      cursor: not-allowed;
    }
    .btn-delete {
      background-color: var(--danger-color);
      color: white;
    }
    .btn-delete:hover {
      background-color: #b91c1c;
    }
    
    /* Çöp Kutusu İkonu Stilleri */
    .delete-icon-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
      opacity: 0.7;
      padding: 4px;
      margin-left: 8px;
    }
    
    .delete-icon-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .delete-icon-preparing {
      color: #6b7280;
    }
    
    .delete-icon-preparing:hover {
      color: #4b5563;
    }
    
    .delete-icon-delivered {
      color: #dc2626;
    }
    
    .delete-icon-delivered:hover {
      color: #b91c1c;
    }
    
    /* Modal Backdrop Efektleri */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .modal-backdrop-light {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    
    /* Modal açıkken header ve navigation'ı arkaya at */
    .modal-open header,
    .modal-open main {
      z-index: 10;
      position: relative;
    }
    
    /* Modal backdrop'unun z-index'ini artır */
    .modal-backdrop,
    .modal-backdrop-light {
      z-index: 80 !important;
    }
    .btn-error {
      background-color: var(--error-color);
      color: white;
    }
    .btn-error:hover {
      background-color: #7e1bb0;
    }
    .empty-state {
      color: #94a3b8;
    }
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -8px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 10;
    }
    .floor-group-btn {
      background-color: #e2e8f0;
      color: #475569;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 8px 16px;
      margin: 0 4px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .floor-group-btn:hover {
      background-color: #cbd5e1;
    }
    .floor-group-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .fade-out {
      animation: fadeShrink 0.6s forwards;
    }
    @keyframes fadeShrink {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }
    .center-message {
      text-align: center;
      font-weight: 600;
      color: #065f46;
      margin: 8px 0;
      width: 100%;
    }
    /* Modal stilleri */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      max-height: 85vh;
      overflow-y: auto;
      width: 95%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .menu-item {
      border-bottom: 1px solid #e2e8f0;
      padding: 12px 0;
    }
    .menu-item:last-child {
      border-bottom: none;
    }
    .add-product-card {
      background-color: #f1f5f9;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px dashed #cbd5e1;
    }
    .add-product-card:hover {
      background-color: #e2e8f0;
      border-color: #94a3b8;
    }
    .form-input {
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 10px 12px;
      transition: border-color 0.2s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .form-submit-btn {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .form-submit-btn:hover {
      background-color: #1d4ed8;
    }
    .form-delete-btn {
      background-color: var(--danger-color);
      color: white;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .form-delete-btn:hover {
      background-color: #b91c1c;
    }
    .scroll-container {
      max-height: 60vh;
      overflow-y: auto;
    }
    /* Scrollbar stilleri */
    .scroll-container::-webkit-scrollbar {
      width: 8px;
    }
    .scroll-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .scroll-container::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
    }
    .scroll-container::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
    .floor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .order-list {
      flex-grow: 1;
      overflow-y: auto;
      max-height: 350px;
      padding: 0.5rem;
    }
    @media (max-width: 768px) {
      .floor-grid {
        grid-template-columns: 1fr;
      }
      .floor-card {
        min-width: 100%;
      }
      .floor-group-btn {
        margin: 2px;
        padding: 6px 12px;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Menü Açma Butonu -->
  <button id="open-menu-btn" class="fixed top-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium">
    Menü
  </button>
  <!-- Menü Modal -->
  <div id="menu-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Menü</h2>
        <button id="close-menu-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <div id="menu-list" class="p-4 scroll-container"></div>
    </div>
  </div>
  <!-- Yeni Ürün Ekle Modal -->
  <div id="add-product-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Yeni Ürün Ekle</h2>
        <button id="close-add-product-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <form id="add-product-form" class="p-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
          <input type="text" name="product-name" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺)</label>
          <input type="number" name="product-price" step="0.01" min="0" class="form-input w-full" required>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Opsiyonlar (Virgülle ayırın)</label>
          <input type="text" name="product-options" placeholder="Örn: Sade, Şekerli, Limonlu" class="form-input w-full">
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="add-product-instock" name="product-instock" class="mr-2" checked>
            <span class="text-sm font-medium text-gray-700">Stokta mevcut</span>
          </label>
        </div>
        <div class="text-center">
          <button type="submit" class="form-submit-btn px-6 py-2">Ürünü Ekle</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Ürün Düzenle Modal -->
  <div id="edit-product-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold text-gray-800">Ürünü Düzenle</h2>
        <button id="close-edit-product-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <form id="edit-product-form" class="p-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı</label>
          <input type="text" id="edit-product-name" name="edit-product-name" class="form-input w-full" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺)</label>
          <input type="number" id="edit-product-price" name="edit-product-price" step="0.01" min="0" class="form-input w-full" required>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Opsiyonlar (Virgülle ayırın)</label>
          <input type="text" id="edit-product-options" name="edit-product-options" placeholder="Örn: Sade, Şekerli, Limonlu" class="form-input w-full">
        </div>
        <div class="mb-6">
          <label class="flex items-center">
            <input type="checkbox" id="edit-product-instock" name="edit-product-instock" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Stokta mevcut</span>
          </label>
        </div>
        <div class="flex justify-between">
          <button type="submit" class="form-submit-btn px-6 py-2">Güncelle</button>
          <button type="button" id="delete-product-btn" class="form-delete-btn px-6 py-2">Sil</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Rapor Butonu -->
<button id="open-report-btn" class="fixed top-16 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium">
  Rapor
</button>
<!-- Tüm Teslim Edilenleri Sil Butonu -->
<button id="delete-all-orders-btn" class="fixed top-36 right-4 z-50 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 font-medium hidden">
  <i class="fas fa-trash-alt mr-1"></i>Tüm Teslim Edilenleri Sil
</button>
<!-- Rapor Modal -->
<div id="report-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold text-gray-800">Satış Raporu</h2>
      <button id="close-report-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>
    <div id="report-content" class="p-6">
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Tarih: <span id="report-date"></span></h3>
      </div>
      <div class="space-y-4">
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Günlük Toplam Satış</span>
            <span id="daily-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Haftalık Toplam Satış</span>
            <span id="weekly-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Aylık Toplam Satış</span>
            <span id="monthly-total" class="text-2xl font-bold text-blue-600">0.00 ₺</span>
          </div>
        </div>
      </div>
      <!-- Rapor Sıfırlama Butonu -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <button id="reset-report-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg shadow-sm transition-all duration-300 font-medium">
          <i class="fas fa-trash-alt mr-2"></i>Rapor Verilerini Sıfırla
        </button>
      </div>
    </div>
  </div>
</div>
</div>
</div>
  <!-- Custom Alert Modal -->
  <div id="alert-modal" class="fixed inset-0 z-90 flex items-center justify-center modal-backdrop-light hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="alert-content">
      <div class="p-6">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0">
            <i id="alert-icon" class="fas fa-info-circle text-blue-500 text-2xl"></i>
          </div>
          <div class="ml-3">
            <h3 id="alert-title" class="text-lg font-medium text-gray-900">Bilgi</h3>
          </div>
        </div>
        <div class="mb-6">
          <p id="alert-message" class="text-sm text-gray-600"></p>
        </div>
        <div class="flex justify-end">
          <button id="alert-ok" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors duration-200">
            Tamam
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Confirm Modal -->
  <div id="confirm-modal" class="fixed inset-0 z-70 flex items-center justify-center modal-backdrop hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="confirm-content">
      <div class="p-6">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0">
            <i id="confirm-icon" class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
          </div>
          <div class="ml-3">
            <h3 id="confirm-title" class="text-lg font-medium text-gray-900">Onay Gerekli</h3>
          </div>
        </div>
        <div class="mb-6">
          <p id="confirm-message" class="text-sm text-gray-600"></p>
        </div>
        <div class="flex justify-end space-x-3">
          <button id="confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors duration-200">
            İptal
          </button>
          <button id="confirm-ok" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors duration-200">
            Onayla
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bildirim Sesi -->
  <audio id="order-notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
  <!-- Ana İçerik -->
  <header class="header-gradient text-white py-6 px-4 shadow-lg">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold flex items-center justify-center">
        <i class="fas fa-mug-hot mr-3"></i>
        Çay Ocağı Sipariş Paneli
      </h1>
      <p class="mt-2 opacity-90 text-center">Siparişleri takip edin ve durumlarını güncelleyin</p>
    </div>
  </header>
  <main class="container mx-auto px-4 py-6">
    <!-- Sekmeler -->
    <div class="flex justify-center border-b border-gray-200 mb-6 relative">
      <button id="preparing-tab" class="tab-active px-6 py-3 text-lg relative">
        Hazırlananlar
        <span id="preparing-badge" class="notification-badge hidden">0</span>
      </button>
      <button id="delivered-tab" class="tab-inactive px-6 py-3 text-lg relative">
        Teslim Edilenler
        <span id="delivered-badge" class="notification-badge hidden">0</span>
      </button>
      <button id="ratings-tab" class="tab-inactive px-6 py-3 text-lg relative">
        Puanlama
        <span id="ratings-badge" class="notification-badge hidden">0</span>
      </button>
    </div>
    

    
    <!-- Kat Grubu Seçimi Butonları -->
    <div class="flex flex-wrap justify-center mb-6">
      <button class="floor-group-btn active" data-group="z123">Zemin ve Kat 1-2-3</button>
    </div>
    
    <!-- Katlar -->
    <div id="floors-container"></div>
    
    <!-- Puanlama Sekmesi İçeriği -->
    <div id="ratings-container" class="hidden">
      <div class="max-w-4xl mx-auto">
        <!-- Ortalama Puan Kartı -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Ortalama Puan</h2>
            <div class="flex items-center justify-center mb-4">
              <span id="average-rating" class="text-4xl font-bold text-blue-600 mr-4">0.0</span>
              <div id="average-stars" class="flex">
                <!-- Yıldızlar JavaScript ile doldurulacak -->
              </div>
            </div>
            <p id="total-ratings" class="text-gray-600">0 değerlendirme</p>
          </div>
        </div>
        
        <!-- Butonlar -->
        <div class="text-center mb-6 space-x-4">
          <button id="refresh-ratings-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 font-medium">
            <i class="fas fa-refresh mr-2"></i>Puanları Yenile
          </button>
          <button id="delete-all-ratings-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 font-medium">
            <i class="fas fa-trash-alt mr-2"></i>Tüm Puanları Sil
          </button>
        </div>
        
        <!-- Puan Listesi -->
        <div id="ratings-list" class="space-y-4">
          <!-- Puanlar JavaScript ile doldurulacak -->
        </div>
      </div>
    </div>
  </main>
  <script type="module">
    // Rapor modal elemanları
const reportModal = document.getElementById('report-modal');
const openReportBtn = document.getElementById('open-report-btn');
const closeReportBtn = document.getElementById('close-report-btn');
const reportDate = document.getElementById('report-date');
const dailyTotal = document.getElementById('daily-total');
const weeklyTotal = document.getElementById('weekly-total');
const monthlyTotal = document.getElementById('monthly-total');

// Rapor modal olay dinleyicileri
openReportBtn.addEventListener('click', () => {
  updateReport();
  reportModal.style.display = 'flex';
});
closeReportBtn.addEventListener('click', () => {
  reportModal.style.display = 'none';
});

// Rapor hesaplama fonksiyonları - Panele göre filtrele
function calculateDailyTotal(orders, date) {
  // Önce panele göre siparişleri filtrele
  const filteredOrders = filterOrdersByPanel(orders);
  
  return filteredOrders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate.getFullYear() === date.getFullYear() &&
           orderDate.getMonth() === date.getMonth() &&
           orderDate.getDate() === date.getDate();
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function calculateWeeklyTotal(orders, date) {
  // Önce panele göre siparişleri filtrele
  const filteredOrders = filterOrdersByPanel(orders);
  
  const startOfWeek = new Date(date);
  startOfWeek.setDate(date.getDate() - date.getDay() + 1);
  startOfWeek.setHours(0, 0, 0, 0);

  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  endOfWeek.setHours(23, 59, 59, 999);

  return filteredOrders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate >= startOfWeek && orderDate <= endOfWeek;
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

function calculateMonthlyTotal(orders, date) {
  // Önce panele göre siparişleri filtrele
  const filteredOrders = filterOrdersByPanel(orders);
  
  return filteredOrders.filter(order => {
    if (order.status !== 'teslim edildi') return false;
    const orderDate = order.tarih.toDate();
    return orderDate.getFullYear() === date.getFullYear() &&
           orderDate.getMonth() === date.getMonth();
  }).reduce((sum, order) => sum + (order.toplamFiyat || 0), 0);
}

async function updateReport() {
  const now = new Date();
  // Sadece kalıcı toplamı göster
  const raporRef = doc(db, "raporlar", activeFloorGroup);
  const raporDoc = await getDoc(raporRef);
  let kaliciToplam = 0;
  if (raporDoc.exists()) {
    kaliciToplam = raporDoc.data().kaliciToplam || 0;
  }
  // Tarih formatla
  reportDate.textContent = now.toLocaleDateString('tr-TR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
  // Sadece toplamı göster
  dailyTotal.textContent = kaliciToplam.toFixed(2) + ' ₺';
  weeklyTotal.textContent = kaliciToplam.toFixed(2) + ' ₺';
  monthlyTotal.textContent = kaliciToplam.toFixed(2) + ' ₺';
}
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy,
      onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc, getDocs, where, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCxtk5JjQiidKZtqOo0QvewUBK0W3TH2xk",
      authDomain: "buski-1b341.firebaseapp.com",
      projectId: "buski-1b341",
      storageBucket: "buski-1b341.firebasestorage.app",
      messagingSenderId: "463802150330",
      appId: "1:463802150330:web:02d0ada7954afb51658183",
      measurementId: "G-V072X4G0BM"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Menü verisi
    let menuData = [];
    let allOrders = [];
    let activeTab = 'preparing'; // 'preparing', 'delivered' veya 'ratings'
    let activeFloorGroup = 'z123'; // Sadece zemin ve kat 1-2-3
    let ratingsData = [];
    let averageRating = 0.0;
    // DOM Elemanları
    const menuModal = document.getElementById('menu-modal');
    const menuListContainer = document.getElementById('menu-list');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const openMenuBtn = document.getElementById('open-menu-btn');
    const addProductModal = document.getElementById('add-product-modal');
    const closeAddProductBtn = document.getElementById('close-add-product-btn');
    const addProductForm = document.getElementById('add-product-form');
    const editProductModal = document.getElementById('edit-product-modal');
    const closeEditProductBtn = document.getElementById('close-edit-product-btn');
    const editProductForm = document.getElementById('edit-product-form');
    const editProductNameInput = document.getElementById('edit-product-name');
    const editProductPriceInput = document.getElementById('edit-product-price');
    const editProductOptionsInput = document.getElementById('edit-product-options');
    const addProductInStockInput = document.getElementById('add-product-instock');
    const editProductInStockInput = document.getElementById('edit-product-instock');
    const preparingTab = document.getElementById('preparing-tab');
    const deliveredTab = document.getElementById('delivered-tab');
    const ratingsTab = document.getElementById('ratings-tab');
    const floorsContainer = document.getElementById('floors-container');
    const ratingsContainer = document.getElementById('ratings-container');
    const preparingBadge = document.getElementById('preparing-badge');
    const deliveredBadge = document.getElementById('delivered-badge');
    const ratingsBadge = document.getElementById('ratings-badge');
    const refreshRatingsBtn = document.getElementById('refresh-ratings-btn');
    const averageRatingSpan = document.getElementById('average-rating');
    const averageStarsDiv = document.getElementById('average-stars');
    const totalRatingsSpan = document.getElementById('total-ratings');
    const ratingsListDiv = document.getElementById('ratings-list');
    const floorGroupButtons = document.querySelectorAll('.floor-group-btn');
    const deleteAllOrdersBtn = document.getElementById('delete-all-orders-btn');
    let editingProductIndex = -1;
    // Modal olay dinleyicileri
    openMenuBtn.addEventListener('click', () => {
      renderMenuList();
      menuModal.style.display = 'flex';
    });
    closeMenuBtn.addEventListener('click', () => {
      menuModal.style.display = 'none';
    });
    closeAddProductBtn.addEventListener('click', () => {
      addProductModal.style.display = 'none';
    });
    closeEditProductBtn.addEventListener('click', () => {
      editProductModal.style.display = 'none';
    });
    // Sekme değişiklikleri
    preparingTab.addEventListener('click', () => {
      setActiveTab('preparing');
    });
    deliveredTab.addEventListener('click', () => {
      setActiveTab('delivered');
    });
    ratingsTab.addEventListener('click', () => {
      setActiveTab('ratings');
    });
    
    // Puanları yenile butonu
    refreshRatingsBtn.addEventListener('click', () => {
      loadRatings();
    });
    
    // Tüm puanları sil butonu
    const deleteAllRatingsBtn = document.getElementById('delete-all-ratings-btn');
    deleteAllRatingsBtn.addEventListener('click', () => {
      window.deleteAllRatings();
    });
    
    // Tüm siparişleri sil butonu olay dinleyicisi
    deleteAllOrdersBtn.addEventListener('click', () => {
      deleteAllOrders();
    });
    // Kat grubu değişiklikleri - Sadece zemin ve kat 1-2-3
    // Bu panel sadece zemin ve kat 1-2-3 için olduğundan değişiklik yok
    // Menü listesini render et
    function renderMenuList() {
      menuListContainer.innerHTML = '';
      menuData.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'menu-item';
        const inStock = item.inStock !== false; // Varsayılan true
        row.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-gray-800">${escapeHtml(item.name)}</div>
              <div class="text-gray-600 mt-1">${item.price} ₺</div>
              <div class="text-gray-500 text-sm mt-1">${item.options && item.options.length ? 'Opsiyonlar: ' + escapeHtml(item.options.join(', ')) : 'Opsiyon yok'}</div>
            </div>
            <div class="flex items-center gap-2">
              <button
                class="text-blue-600 hover:text-blue-800 p-2"
                title="Düzenle"
                data-idx="${idx}"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="text-gray-500 hover:text-gray-700 p-2"
                title="Stok Durumu"
                data-stock-idx="${idx}"
              >
                <i class="fas ${inStock ? 'fa-eye' : 'fa-eye-slash'}"></i>
              </button>
            </div>
          </div>
        `;
        const editButton = row.querySelector('button[data-idx]');
        editButton.addEventListener('click', (e) => {
          editingProductIndex = Number(e.currentTarget.getAttribute('data-idx'));
          const productToEdit = menuData[editingProductIndex];
          editProductNameInput.value = productToEdit.name;
          editProductPriceInput.value = productToEdit.price;
          editProductOptionsInput.value = productToEdit.options.join(', ');
          // Stok durumu checkbox'ı
          if (editProductInStockInput) {
            editProductInStockInput.checked = productToEdit.inStock !== false;
          }
          editProductModal.style.display = 'flex';
        });
        // Göz (stok) butonu
        const stockButton = row.querySelector('button[data-stock-idx]');
        stockButton.addEventListener('click', async (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-stock-idx'));
          menuData[idx].inStock = !(menuData[idx].inStock !== false);
          await saveMenuToFirestore();
          renderMenuList();
        });
        menuListContainer.appendChild(row);
      });
      const addProductCard = document.createElement('div');
      addProductCard.className = 'add-product-card mt-2';
      addProductCard.innerHTML = `
        <i class="fas fa-plus-circle text-2xl text-gray-400 mb-2"></i>
        <div class="text-gray-600 font-medium">Yeni Ürün Ekle</div>
      `;
      addProductCard.addEventListener('click', () => {
        addProductModal.style.display = 'flex';
      });
      menuListContainer.appendChild(addProductCard);
    }
    // Yardımcı fonksiyon: HTML kaçış
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
    // Yeni ürün ekleme form submit
    addProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(addProductForm);
      const name = formData.get('product-name').trim();
      const price = parseFloat(formData.get('product-price'));
      const optionsText = formData.get('product-options').trim();
      if (!name || isNaN(price) || price < 0) {
        await showAlert('Lütfen geçerli ürün adı ve fiyat giriniz.', 'warning');
        return;
      }
      const options = optionsText ? optionsText.split(',').map(opt => opt.trim()).filter(opt => opt) : [];
      const defaultOption = options.length > 0 ? options[0] : '';
      const newProduct = {
        name: name,
        price: price,
        options: options,
        defaultOption: defaultOption,
        inStock: addProductInStockInput.checked
      };
      menuData.push(newProduct);
      await saveMenuToFirestore();
      addProductModal.style.display = 'none';
      addProductForm.reset();
      renderMenuList();
    });
    // Ürün düzenleme form submit
    editProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editProductForm);
      const name = formData.get('edit-product-name').trim();
      const price = parseFloat(formData.get('edit-product-price'));
      const optionsText = formData.get('edit-product-options').trim();
      if (!name || isNaN(price) || price < 0) {
        await showAlert('Lütfen geçerli ürün adı ve fiyat giriniz.', 'warning');
        return;
      }
      const options = optionsText ? optionsText.split(',').map(opt => opt.trim()).filter(opt => opt) : [];
      const defaultOption = options.length > 0 ? options[0] : '';
      if (editingProductIndex !== -1) {
        menuData[editingProductIndex] = {
          name: name,
          price: price,
          options: options,
          defaultOption: defaultOption,
          inStock: editProductInStockInput.checked
        };
        await saveMenuToFirestore();
      }
      editProductModal.style.display = 'none';
      renderMenuList();
    });
    // Ürün silme
    document.getElementById('delete-product-btn').addEventListener('click', async () => {
      if (editingProductIndex !== -1) {
        if (confirm('Bu ürünü silmek istediğinizden emin misiniz?')) {
          menuData.splice(editingProductIndex, 1);
          await saveMenuToFirestore();
          editProductModal.style.display = 'none';
          renderMenuList();
        }
      }
    });
    // Firestore'dan menüyü oku - Kat 1-2-3 için
    async function fetchMenuFromFirestore() {
      const menuDocRef = doc(db, "menu", "kat123");
      const menuDoc = await getDoc(menuDocRef);
      if (menuDoc.exists()) {
        menuData = menuDoc.data().items || [];
      } else {
        menuData = [];
        await setDoc(menuDocRef, { items: menuData });
      }
      renderMenuList();
    }
    // Firestore'a menüyü kaydet - Kat 1-2-3 için
    async function saveMenuToFirestore() {
      const menuDocRef = doc(db, "menu", "kat123");
      await setDoc(menuDocRef, { items: menuData });
    }
    // Firestore'daki menüde değişiklikleri dinle - Kat 1-2-3 için
    function listenMenuRealtime() {
      const menuDocRef = doc(db, "menu", "kat123");
      onSnapshot(menuDocRef, (docSnap) => {
        if (docSnap.exists()) {
          menuData = docSnap.data().items || [];
          renderMenuList();
        }
      });
    }
    // Sekme değiştirme
    function setActiveTab(tab) {
      activeTab = tab;
      
      // Tüm sekmeleri pasif yap
      preparingTab.classList.remove('tab-active');
      preparingTab.classList.add('tab-inactive');
      deliveredTab.classList.remove('tab-active');
      deliveredTab.classList.add('tab-inactive');
      ratingsTab.classList.remove('tab-active');
      ratingsTab.classList.add('tab-inactive');
      
      // Tüm container'ları gizle
      floorsContainer.classList.add('hidden');
      ratingsContainer.classList.add('hidden');
      
      if (tab === 'preparing') {
        preparingTab.classList.add('tab-active');
        preparingTab.classList.remove('tab-inactive');
        floorsContainer.classList.remove('hidden');
        deleteAllOrdersBtn.classList.add('hidden');
        renderFloors();
      } else if (tab === 'delivered') {
        deliveredTab.classList.add('tab-active');
        deliveredTab.classList.remove('tab-inactive');
        floorsContainer.classList.remove('hidden');
        deleteAllOrdersBtn.classList.remove('hidden');
        renderFloors();
      } else if (tab === 'ratings') {
        ratingsTab.classList.add('tab-active');
        ratingsTab.classList.remove('tab-inactive');
        ratingsContainer.classList.remove('hidden');
        deleteAllOrdersBtn.classList.add('hidden');
        loadRatings();
      }
    }
    
    // Puanları yükle
    async function loadRatings() {
      try {
        // Normal siparişlerden puanları çek
        const snapshot = await getDocs(query(
          collection(db, "siparisler"),
          where("rating", ">", 0)
        ));
        
        // Korunan puanlamalardan da çek
        const preservedSnapshot = await getDocs(collection(db, "preserved_ratings"));
        
        // Normal siparişlerden puanları al
        let normalRatings = snapshot.docs
          .map(doc => ({
            id: doc.id,
            ...doc.data(),
            isPreserved: false
          }))
          .filter(rating => {
            const floor = Number(rating.floor);
            return floor >= 1 && floor <= 3; // Kat 1-2-3 (zemin hariç)
          });
        
        // Korunan puanlamalardan al
        let preservedRatings = preservedSnapshot.docs
          .map(doc => ({
            id: doc.id,
            ...doc.data(),
            isPreserved: true
          }))
          .filter(rating => {
            const floor = Number(rating.userFloor);
            return floor >= 1 && floor <= 3; // Kat 1-2-3 (zemin hariç)
          });
        
        // Tüm puanları birleştir ve tarihe göre sırala
        ratingsData = [...normalRatings, ...preservedRatings]
          .sort((a, b) => {
            // Tarihe göre sırala (en yeni önce)
            const dateA = a.ratingDate && a.ratingDate.toDate ? a.ratingDate.toDate() : 
                         a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(0);
            const dateB = b.ratingDate && b.ratingDate.toDate ? b.ratingDate.toDate() : 
                         b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(0);
            return dateB - dateA;
          });
        
        // Kullanıcı bilgilerini çek
        for (let rating of ratingsData) {
          if (rating.userId && !rating.isPreserved) {
            try {
              const userDoc = await getDoc(doc(db, "users", rating.userId));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                rating.userName = userData.fullName || userData.name || 'İsimsiz Kullanıcı';
              } else {
                rating.userName = 'İsimsiz Kullanıcı';
              }
            } catch (error) {
              console.error('Kullanıcı bilgisi çekilirken hata:', error);
              rating.userName = 'İsimsiz Kullanıcı';
            }
          } else if (rating.isPreserved) {
            // Korunan puanlamalarda kullanıcı adı zaten var
            rating.userName = rating.userName || 'İsimsiz Kullanıcı';
          } else {
            rating.userName = 'İsimsiz Kullanıcı';
          }
        }
        
        // Ortalama puanı hesapla
        if (ratingsData.length > 0) {
          const totalRating = ratingsData.reduce((sum, rating) => sum + (rating.rating || 0), 0);
          averageRating = totalRating / ratingsData.length;
        } else {
          averageRating = 0;
        }
        
        renderRatings();
      } catch (error) {
        console.error('Puanlar yüklenirken hata:', error);
      }
    }
    
    // Puanları render et
    function renderRatings() {
      // Ortalama puanı güncelle
      averageRatingSpan.textContent = averageRating.toFixed(1);
      totalRatingsSpan.textContent = `${ratingsData.length} değerlendirme`;
      
      // Ortalama yıldızları render et
      averageStarsDiv.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const star = document.createElement('i');
        if (i < Math.floor(averageRating)) {
          star.className = 'fas fa-star text-yellow-400 text-2xl';
        } else if (i < averageRating) {
          star.className = 'fas fa-star-half-alt text-yellow-400 text-2xl';
        } else {
          star.className = 'far fa-star text-gray-300 text-2xl';
        }
        averageStarsDiv.appendChild(star);
      }
      
      // Puan listesini render et
      ratingsListDiv.innerHTML = '';
      
      if (ratingsData.length === 0) {
        ratingsListDiv.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-star text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">Henüz puanlama yapılmamış</p>
          </div>
        `;
        return;
      }
      
      ratingsData.forEach(rating => {
        const ratingCard = document.createElement('div');
        ratingCard.className = 'bg-white rounded-lg shadow-md p-6';
        
        const ratingValue = rating.rating || 0;
        const comment = rating.comment || '';
        const userName = rating.userName || 'İsimsiz Kullanıcı';
        const floor = rating.floor || rating.userFloor || 0;
        const floorName = floor === 0 ? 'Zemin' : `Kat ${floor}`;
        const displayName = userName !== 'İsimsiz Kullanıcı' ? `${userName} (${floorName})` : `İsimsiz Kullanıcı (${floorName})`;
        const tarih = rating.ratingDate && rating.ratingDate.toDate ? 
          rating.ratingDate.toDate() : new Date();
        
        let starsHtml = '';
        for (let i = 0; i < 5; i++) {
          starsHtml += `<i class="fas fa-star ${i < ratingValue ? 'text-yellow-400' : 'text-gray-300'}" style="font-size: 16px;"></i>`;
        }
        
        ratingCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-bold text-lg text-gray-800">${escapeHtml(displayName)}</h3>
              <p class="text-gray-500 text-sm">${tarih.toLocaleDateString('tr-TR')}</p>
            </div>
            <div class="flex items-center gap-2">
              ${starsHtml}
              <span class="ml-2 text-sm text-gray-500">(${ratingValue}/5)</span>
              <button 
                onclick="deleteRating('${rating.id}')" 
                class="ml-2 text-red-500 hover:text-red-700 p-1 rounded"
                title="Bu puanlamayı sil"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          ${comment ? `
            <div class="bg-gray-50 rounded-lg p-4">
              <p class="text-gray-700">${escapeHtml(comment)}</p>
            </div>
          ` : ''}
        `;
        
        ratingsListDiv.appendChild(ratingCard);
      });
    }

    // Puanlama silme fonksiyonu
    window.deleteRating = async function(ratingId) {
      const confirmed = await showConfirm('Puanlama Silme', 'Bu puanlamayı silmek istediğinizden emin misiniz?', 'warning');
      if (confirmed) {
        try {
          // Önce korunan puanlamalarda ara
          const preservedRef = doc(db, "preserved_ratings", ratingId);
          const preservedDoc = await getDoc(preservedRef);
          
          if (preservedDoc.exists()) {
            // Korunan puanlamadan sil
            await deleteDoc(preservedRef);
          } else {
            // Normal siparişten puanlamayı sil
            const ref = doc(db, "siparisler", ratingId);
            await updateDoc(ref, { 
              rating: 0, 
              comment: '', 
              ratingDate: null 
            });
          }
          
          // Puanlamaları yeniden yükle
          loadRatings();
        } catch (error) {
          console.error("Puanlama silinirken hata oluştu:", error);
          await showAlert("Puanlama silinirken bir sorun oluştu.", 'error');
        }
      }
    };

    // Tüm puanları sil
    window.deleteAllRatings = async function() {
      const confirmed = await showConfirm('Tüm Puanları Sil', 'Bu işlem tüm puanları ve yorumları kalıcı olarak silecektir. Devam etmek istediğinizden emin misiniz?', 'warning');
      if (confirmed) {
        try {
          // Kat grubuna göre siparişleri filtrele
          const filteredOrders = filterOrdersByPanel(allOrders);
          const ordersWithRatings = filteredOrders.filter(order => order.rating && order.rating > 0);
          
          // Tüm puanları sil
          const batch = writeBatch(db);
          ordersWithRatings.forEach(order => {
            const orderRef = doc(db, "siparisler", order.id);
            batch.update(orderRef, {
              rating: 0,
              comment: "",
              ratingDate: null
            });
          });
          
          await batch.commit();
          
          // Korunan puanlamaları da sil
          const preservedSnapshot = await getDocs(collection(db, "preserved_ratings"));
          const preservedBatch = writeBatch(db);
          preservedSnapshot.docs.forEach(doc => {
            const ratingData = doc.data();
            const floor = Number(ratingData.userFloor);
            if (floor >= 1 && floor <= 3) { // Kat 1-2-3
              preservedBatch.delete(doc.ref);
            }
          });
          await preservedBatch.commit();
          
          // Puanları yeniden yükle
          loadRatings();
          
          await showAlert(`${ordersWithRatings.length} puanlama başarıyla silindi.`, 'success');
        } catch (error) {
          console.error("Tüm puanlar silinirken hata oluştu:", error);
          await showAlert("Tüm puanlar silinirken bir sorun oluştu.", 'error');
        }
      }
    };

    // Hata butonu işlevi: Siparişi hazırlananlar sekmesine geri döndürür
    window.revertToPreparing = async function(id, btn) {
        const confirmed = await showConfirm('Sipariş Geri Alma', 'Bu siparişi hazırlananlar sekmesine geri almak istediğinizden emin misiniz?', 'warning');
        if (confirmed) {
            const ref = doc(db, "siparisler", id);
            try {
                await updateDoc(ref, { status: "hazırlanıyor" });
                
                // Otomatik olarak "Hazırlananlar" sekmesine geç
                if (activeTab !== 'preparing') {
                    setActiveTab('preparing');2
                }
                
                console.log("Sipariş durumu güncellendi:", id);
            } catch (error) {
                console.error("Hata durumu güncellenirken hata oluştu:", error);
                await showAlert("Hata durumu güncellenirken bir sorun oluştu.", 'error');
            }
        }
    };

    // Katları render et - Sadece zemin ve kat 1-2-3
    function renderFloors() {
      floorsContainer.innerHTML = '';
      
      const floorsToShow = [
        { floor: 0, name: 'Zemin' },
        { floor: 1, name: 'Kat 1' },
        { floor: 2, name: 'Kat 2' },
        { floor: 3, name: 'Kat 3' }
      ];
      const groupName = "Zemin ve Katlar 1 - 2 - 3";
      
      const groupRow = document.createElement('div');
      groupRow.className = 'mb-8';
      groupRow.innerHTML = `<h2 class="text-xl font-bold text-center mb-4 text-gray-700">${groupName}</h2>`;
      const groupGrid = document.createElement('div');
      groupGrid.className = 'floor-grid';
      
      floorsToShow.forEach(({floor, name}) => {
        const floorCard = createFloorCard(floor, name);
        groupGrid.appendChild(floorCard);
      });
      
      groupRow.appendChild(groupGrid);
      floorsContainer.appendChild(groupRow);
    }
    // Kat kartı oluştur (floor: kat numarası, floorName: gösterilecek isim)
    function createFloorCard(floor, floorName) {
      const floorCard = document.createElement('div');
      floorCard.className = 'floor-card';
      const title = document.createElement('div');
      title.className = 'font-bold text-lg mb-4 text-center pb-2 border-b';
      title.textContent = floorName;
      floorCard.appendChild(title);
      const ordersContainer = document.createElement('div');
      ordersContainer.className = 'order-list';
      // Aktif sekmeye göre siparişleri filtrele
      let filteredOrders = [];
      if (activeTab === 'preparing') {
        filteredOrders = allOrders.filter(order => 
          Number(order.floor) === floor && 
          order.status !== "teslim edildi"
        );
      } else {
        filteredOrders = allOrders.filter(order => 
          Number(order.floor) === floor && 
          order.status === "teslim edildi"
        );
      }
      if (filteredOrders.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state text-center py-8';
        emptyState.innerHTML = `
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p class="mt-2">${activeTab === 'preparing' ? 'Hazırlanacak sipariş yok' : 'Teslim edilen sipariş yok'}</p>
        `;
        ordersContainer.appendChild(emptyState);
      } else {
        filteredOrders.forEach(order => {
          const orderCard = createOrderCard(order);
          ordersContainer.appendChild(orderCard);
        });
      }
      floorCard.appendChild(ordersContainer);
      return floorCard;
    }
    // Sipariş kartı oluştur
    function createOrderCard(order) {
      const card = document.createElement('div');
      const status = order.status || "hazırlanıyor";
      // Kart sınıfını belirle
      let cardClass = 'order-card p-4 mb-3';
      if (status === 'hazırlanıyor') {
        cardClass += ' order-card-preparing';
      } else if (status === 'hazırlandı') {
        cardClass += ' order-card-ready';
      } else if (status === 'teslim edildi') {
        cardClass += ' order-card-delivered';
      }
      card.className = cardClass;
      // Ürünler listesi
      let itemsHtml = '-';
      if (Array.isArray(order.items) && order.items.length > 0) {
        itemsHtml = order.items.map(item => 
          `${escapeHtml(item.name)}${item.option ? ' (' + escapeHtml(item.option) + ')' : ''} - ${escapeHtml(item.adet.toString())} adet`
        ).join('<br>');
      }
      // Buton metni ve sınıfı
      let buttonText = 'Hazırlanıyor...';
      let buttonClass = 'status-btn btn-preparing';
      let buttonIcon = '<i class="fas fa-spinner mr-2"></i>';
      let disabled = false;
      if (status === 'hazırlandı') {
        buttonText = 'Hazırlandı';
        buttonClass = 'status-btn btn-ready';
        buttonIcon = '<i class="fas fa-check mr-2"></i>';
      } else if (status === 'teslim edildi') {
        buttonText = 'Teslim Edildi';
        buttonClass = 'status-btn btn-delivered';
        buttonIcon = '<i class="fas fa-check-circle mr-2"></i>';
        disabled = true;
      }
      card.innerHTML = `
        <div class="grid grid-cols-1 gap-2 mb-3 text-sm">
          <div><span class="font-medium">Ad:</span> ${escapeHtml(order.ad || '')}</div>
          <div><span class="font-medium">Departman:</span> ${escapeHtml(order.departman || '')}</div>
          <div><span class="font-medium">Tarih:</span> ${order.tarih?.toDate ? escapeHtml(order.tarih.toDate().toLocaleString('tr-TR')) : ''}</div>
        </div>
        <div class="mb-3">
          <div class="font-medium mb-1">Sipariş İçeriği:</div>
          <div class="ml-3 text-sm">
            ${itemsHtml}
          </div>
          <div class="ml-3 mt-2 font-bold">
            Toplam: ${escapeHtml((order.toplamFiyat || 0).toString())} ₺
          </div>
          ${order.rating ? `
          <div class="ml-3 mt-2 flex items-center">
            <span class="text-sm text-gray-600 mr-2">Puan:</span>
            <div class="flex">
              ${Array.from({length: 5}, (_, i) => 
                `<i class="fas fa-star ${i < order.rating ? 'text-yellow-400' : 'text-gray-300'}" style="font-size: 14px;"></i>`
              ).join('')}
            </div>
            <span class="ml-2 text-sm text-gray-500">(${order.rating}/5)</span>
          </div>
          ` : ''}
        </div>
        <div class="flex justify-between items-center mt-3 pt-3 border-t relative">
          <button class="${buttonClass} px-3 py-2 text-sm" onclick="cycleStatus('${order.id}', this)" ${disabled ? 'disabled' : ''}>
            ${buttonIcon}${buttonText}
          </button>
          
          <!-- Çöp Kutusu İkonu -->
          <button class="delete-icon-btn ${activeTab === 'preparing' ? 'delete-icon-preparing' : 'delete-icon-delivered'}" 
                  onclick="deleteOrder('${order.id}', this)" 
                  title="Siparişi Sil">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      return card;
    }
    // Sipariş durumunu değiştir
    window.cycleStatus = async function (id, btn) {
      const ref = doc(db, "siparisler", id);
      const order = allOrders.find(o => o.id === id);
      if (!order) return;
      const currentStatus = order.status || "hazırlanıyor";
      if (currentStatus === "hazırlanıyor") {
        await updateDoc(ref, { status: "hazırlandı" });
      } else if (currentStatus === "hazırlandı") {
        const card = btn.closest('.order-card');
        if (card) {
          const msg = document.createElement('div');
          msg.className = 'center-message';
          msg.textContent = 'Teslim Edildi.';
          card.appendChild(msg);
          setTimeout(() => {
            card.classList.add('fade-out');
            setTimeout(async () => {
              await updateDoc(ref, { status: "teslim edildi" });
              // --- RAPOR TOPLAMINI ARTIR ---
              await increaseReportTotal(order);
            }, 600);
          }, 1000);
        } else {
          await updateDoc(ref, { status: "teslim edildi" });
          // --- RAPOR TOPLAMINI ARTIR ---
          await increaseReportTotal(order);
        }
      }
      // Badge sayılarını güncelle
      updateBadges().catch(console.error);
    };

    // Rapor toplamını artıran fonksiyon
    async function increaseReportTotal(order) {
      try {
        const raporRef = doc(db, "raporlar", activeFloorGroup);
        const raporDoc = await getDoc(raporRef);
        let total = 0;
        if (raporDoc.exists()) {
          total = raporDoc.data().kaliciToplam || 0;
          // Sipariş zaten eklendiyse tekrar ekleme
          const eklenenSiparisler = raporDoc.data().eklenenSiparisler || [];
          if (eklenenSiparisler.includes(order.id)) return;
          eklenenSiparisler.push(order.id);
          await setDoc(raporRef, {
            kaliciToplam: total + (order.toplamFiyat || 0),
            eklenenSiparisler,
          }, { merge: true });
        } else {
          await setDoc(raporRef, {
            kaliciToplam: (order.toplamFiyat || 0),
            eklenenSiparisler: [order.id],
          });
        }
      } catch (error) {
        console.error('Rapor toplamı artırılırken hata:', error);
      }
    }
    // Siparişi sil
    window.deleteOrder = async function(id, btn) {
      const confirmed = await showConfirm('Sipariş Silme', 'Bu siparişi silmek istediğinizden emin misiniz?', 'warning');
      if (confirmed) {
        try {
          const order = allOrders.find(o => o.id === id);
          const ref = doc(db, "siparisler", id);
          
          console.log('Silinecek sipariş:', order); // Debug için
          
          // Eğer siparişin puanlaması varsa, puanlama verilerini koru
          if (order && (order.rating > 0 || order.comment)) {
            console.log('Puanlama bulundu, korunuyor:', order.rating, order.comment); // Debug için
            
            // Siparişi sil ama puanlama verilerini ayrı bir koleksiyonda sakla
            const ratingData = {
              orderId: id,
              rating: order.rating || 0,
              comment: order.comment || '',
              userName: order.ad || '',
              userDepartment: order.departman || '',
              userFloor: order.floor || 0,
              timestamp: order.tarih || new Date(),
              preservedAt: new Date()
            };
            
            console.log('Korunan puanlama verisi:', ratingData); // Debug için
            
            // Puanlama verilerini ayrı koleksiyonda sakla
            await setDoc(doc(db, "preserved_ratings", id), ratingData);
            console.log('Puanlama korundu'); // Debug için
          } else {
            console.log('Puanlama bulunamadı, korunmuyor'); // Debug için
          }
          
          await deleteDoc(ref);
          const card = btn.closest('.order-card');
          if (card) {
            card.remove();
          }
          // Badge sayılarını güncelle
          updateBadges().catch(console.error);
        } catch (error) {
          console.error('Sipariş silinirken hata oluştu:', error);
          await showAlert('Sipariş silinirken bir hata oluştu: ' + error.message, 'error');
        }
      }
    };
    
    // Tüm teslim edilmiş siparişleri sil fonksiyonu
    async function deleteAllOrders() {
      const confirmed = await showConfirm('Toplu Silme', 'TÜM TESLİM EDİLMİŞ SİPARİŞLERİ SİLMEK İSTEDİĞİNİZDEN EMİN MİSİNİZ? Bu işlem geri alınamaz!', 'danger');
      if (confirmed) {
        try {
          // Panele göre siparişleri filtrele ve sadece teslim edilmiş olanları al
          const filteredOrders = filterOrdersByPanel(allOrders);
          const deliveredOrders = filteredOrders.filter(order => order.status === 'teslim edildi');

          // --- RAPORU GÜNCELLE (kaliciToplam ve eklenenSiparisler) ---
          const raporRef = doc(db, "raporlar", activeFloorGroup);
          const raporDoc = await getDoc(raporRef);
          let kaliciToplam = 0;
          let eklenenSiparisler = [];
          if (raporDoc.exists()) {
            kaliciToplam = raporDoc.data().kaliciToplam || 0;
            eklenenSiparisler = raporDoc.data().eklenenSiparisler || [];
          }
          let yeniToplam = kaliciToplam;
          let yeniEklenenler = [...eklenenSiparisler];
          for (const order of deliveredOrders) {
            if (!yeniEklenenler.includes(order.id)) {
              yeniToplam += order.toplamFiyat || 0;
              yeniEklenenler.push(order.id);
            }
          }
          await setDoc(raporRef, {
            kaliciToplam: yeniToplam,
            eklenenSiparisler: yeniEklenenler,
            lastUpdated: new Date(),
            floorGroup: activeFloorGroup
          }, { merge: true });
          // --- SONU ---

          // Her teslim edilmiş siparişi Firebase'den sil
          for (const order of deliveredOrders) {
            // Eğer siparişin puanlaması varsa, puanlama verilerini koru
            if (order.rating > 0 || order.comment) {
              console.log('Toplu silmede puanlama korunuyor:', order.id, order.rating, order.comment);
              
              const ratingData = {
                orderId: order.id,
                rating: order.rating || 0,
                comment: order.comment || '',
                userName: order.ad || '',
                userDepartment: order.departman || '',
                userFloor: order.floor || 0,
                timestamp: order.tarih || new Date(),
                preservedAt: new Date()
              };
              
              // Puanlama verilerini ayrı koleksiyonda sakla
              await setDoc(doc(db, "preserved_ratings", order.id), ratingData);
            }
            
            await deleteDoc(doc(db, "siparisler", order.id));
          }
          
          // Badge sayılarını güncelle
          await updateBadges().catch(console.error);
          
          // Puanlamaları yeniden yükle
          await loadRatings();
        } catch (error) {
          console.error('Toplu silme işleminde hata oluştu:', error);
          await showAlert('Toplu silme işleminde bir hata oluştu: ' + error.message, 'error');
        }
      }
    }
    
    // Rapor verilerini kaydet
    async function saveReportData() {
      try {
        const now = new Date();
        const dailyTotal = calculateDailyTotal(allOrders, now);
        const weeklyTotal = calculateWeeklyTotal(allOrders, now);
        const monthlyTotal = calculateMonthlyTotal(allOrders, now);
        
        const reportData = {
          dailyTotal: dailyTotal,
          weeklyTotal: weeklyTotal,
          monthlyTotal: monthlyTotal,
          lastUpdated: now,
          floorGroup: activeFloorGroup
        };
        
        await setDoc(doc(db, "raporlar", activeFloorGroup), reportData);
      } catch (error) {
        console.error('Rapor verileri kaydedilirken hata oluştu:', error);
      }
    }
    
    // Rapor verilerini yükle
    async function loadReportData() {
      try {
        const reportDoc = await getDoc(doc(db, "raporlar", activeFloorGroup));
        if (reportDoc.exists()) {
          return reportDoc.data();
        }
      } catch (error) {
        console.error('Rapor verileri yüklenirken hata oluştu:', error);
      }
      return null;
    }
    
    // Rapor sıfırlama fonksiyonu
    async function resetReportData() {
      // Önce rapor modal'ını kapat
      reportModal.style.display = 'none';
      
      const confirmed = await showConfirm('Rapor Sıfırlama', 'RAPOR VERİLERİNİ SIFIRLAMAK İSTEDİĞİNİZDEN EMİN MİSİNİZ? Bu işlem geri alınamaz!', 'danger');
      if (confirmed) {
        try {
          const raporRef = doc(db, "raporlar", activeFloorGroup);
          await setDoc(raporRef, {
            kaliciToplam: 0,
            eklenenSiparisler: [],
            lastUpdated: new Date(),
            floorGroup: activeFloorGroup
          });
          updateReport();
          // Başarı alert'ini kaldırdık
        } catch (error) {
          console.error('Rapor verileri sıfırlanırken hata oluştu:', error);
          await showAlert('Rapor verileri sıfırlanırken bir hata oluştu: ' + error.message, 'error');
        }
      }
    }
    
    // Custom Alert ve Confirm Modal'ları
    const alertModal = document.getElementById('alert-modal');
    const alertContent = document.getElementById('alert-content');
    const alertIcon = document.getElementById('alert-icon');
    const alertTitle = document.getElementById('alert-title');
    const alertMessage = document.getElementById('alert-message');
    const alertOk = document.getElementById('alert-ok');

    const confirmModal = document.getElementById('confirm-modal');
    const confirmContent = document.getElementById('confirm-content');
    const confirmIcon = document.getElementById('confirm-icon');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');

    // Custom Alert fonksiyonu
    function showAlert(message, type = 'info') {
      return new Promise((resolve) => {
        let iconClass = '';
        let title = '';
        switch(type) {
          case 'success': iconClass = 'fas fa-check-circle text-green-500'; title = 'Başarılı'; break;
          case 'error': iconClass = 'fas fa-exclamation-circle text-red-500'; title = 'Hata'; break;
          case 'warning': iconClass = 'fas fa-exclamation-triangle text-yellow-500'; title = 'Uyarı'; break;
          case 'info': iconClass = 'fas fa-info-circle text-blue-500'; title = 'Bilgi'; break;
          default: iconClass = 'fas fa-info-circle text-blue-500'; title = 'Bilgi';
        }
        
        alertIcon.className = iconClass;
        alertTitle.textContent = title;
        alertMessage.textContent = message;
        
        // Body'ye modal-open sınıfını ekle
        document.body.classList.add('modal-open');
        
        alertModal.classList.remove('hidden');
        setTimeout(() => {
          alertContent.classList.remove('scale-95', 'opacity-0');
          alertContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        const handleOk = () => {
          hideAlert();
          resolve();
        };
        
        alertOk.addEventListener('click', handleOk, { once: true });
        
        // ESC tuşu ile kapatma
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleOk();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }

    function hideAlert() {
      alertContent.classList.remove('scale-100', 'opacity-100');
      alertContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        alertModal.classList.add('hidden');
        // Body'den modal-open sınıfını kaldır
        document.body.classList.remove('modal-open');
      }, 300);
    }

    // Custom Confirm fonksiyonu
    function showConfirm(title, message, type = 'warning') {
      return new Promise((resolve) => {
        let iconClass = '';
        let buttonColor = '';
        switch(type) {
          case 'danger': iconClass = 'fas fa-exclamation-triangle text-red-500'; buttonColor = 'bg-red-600 hover:bg-red-700'; break;
          case 'warning': iconClass = 'fas fa-exclamation-triangle text-yellow-500'; buttonColor = 'bg-yellow-600 hover:bg-yellow-700'; break;
          case 'info': iconClass = 'fas fa-info-circle text-blue-500'; buttonColor = 'bg-blue-600 hover:bg-blue-700'; break;
          default: iconClass = 'fas fa-exclamation-triangle text-yellow-500'; buttonColor = 'bg-yellow-600 hover:bg-yellow-700';
        }
        
        confirmIcon.className = iconClass;
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmOk.className = `px-4 py-2 text-sm font-medium text-white ${buttonColor} rounded-md transition-colors duration-200`;
        
        // Body'ye modal-open sınıfını ekle
        document.body.classList.add('modal-open');
        
        confirmModal.classList.remove('hidden');
        setTimeout(() => {
          confirmContent.classList.remove('scale-95', 'opacity-0');
          confirmContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        const handleConfirm = () => {
          hideConfirm();
          resolve(true);
        };
        
        const handleCancel = () => {
          hideConfirm();
          resolve(false);
        };
        
        confirmOk.addEventListener('click', handleConfirm, { once: true });
        confirmCancel.addEventListener('click', handleCancel, { once: true });
        
        // ESC tuşu ile iptal
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }

    function hideConfirm() {
      confirmContent.classList.remove('scale-100', 'opacity-100');
      confirmContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        confirmModal.classList.add('hidden');
        // Body'den modal-open sınıfını kaldır
        document.body.classList.remove('modal-open');
      }, 300);
    }

    // Rapor sıfırlama butonu olay dinleyicisi
    document.getElementById('reset-report-btn').addEventListener('click', resetReportData);
    // Bildirim sesi çal
    function playOrderNotification() {
      const audio = document.getElementById('order-notification-sound');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Ses çalınamadı:", e));
      }
    }
    // Panele göre siparişleri filtrele
    function filterOrdersByPanel(orders) {
      if (activeFloorGroup === 'z123') {
        // Zemin ve kat 1-2-3 (zemin hariç)
        return orders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 1 && orderFloor <= 3;
        });
      } else if (activeFloorGroup === '456') {
        // Kat 4-5-6
        return orders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 4 && orderFloor <= 6;
        });
      } else if (activeFloorGroup === '78910') {
        // Kat 7-8-9-10
        return orders.filter(order => {
          const orderFloor = Number(order.floor);
          return orderFloor >= 7 && orderFloor <= 10;
        });
      }
      return orders; // Varsayılan olarak tüm siparişler
    }
    
    // Badge sayılarını güncelle - Sadece o kat grubunun siparişlerini say
    async function updateBadges() {
      // Kat grubuna göre siparişleri filtrele
      let filteredOrders = filterOrdersByPanel(allOrders);
      
      const preparingCount = filteredOrders.filter(order => 
        order.status !== "teslim edildi"
      ).length;
      const deliveredCount = filteredOrders.filter(order => 
        order.status === "teslim edildi"
      ).length;
      
      // Normal siparişlerden puanlama sayısı
      let ratingsCount = filteredOrders.filter(order => 
        order.rating && order.rating > 0
      ).length;
      
      // Korunan puanlamalardan da say
      try {
        const preservedSnapshot = await getDocs(collection(db, "preserved_ratings"));
        const preservedRatings = preservedSnapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(rating => {
            const floor = Number(rating.userFloor);
            if (activeFloorGroup === 'z123') {
              return floor >= 1 && floor <= 3;
            } else if (activeFloorGroup === '456') {
              return floor >= 4 && floor <= 6;
            } else if (activeFloorGroup === '78910') {
              return floor >= 7 && floor <= 10;
            }
            return false;
          });
        
        ratingsCount += preservedRatings.length;
      } catch (error) {
        console.error('Korunan puanlamalar sayılırken hata:', error);
      }
      
      preparingBadge.textContent = preparingCount;
      deliveredBadge.textContent = deliveredCount;
      ratingsBadge.textContent = ratingsCount;
      preparingBadge.classList.toggle('hidden', preparingCount === 0);
      deliveredBadge.classList.toggle('hidden', deliveredCount === 0);
      ratingsBadge.classList.toggle('hidden', ratingsCount === 0);
    }
    // Siparişleri Firestore'dan çek
    const q = query(collection(db, "siparisler"), orderBy("tarih", "desc"));
    let lastOrderIds = [];
    onSnapshot(q, (snapshot) => {
      const currentOrderIds = snapshot.docs.map(docSnap => docSnap.id);
      // Yeni sipariş geldiyse bildirim sesi çal
      if (lastOrderIds.length > 0 && currentOrderIds.length > lastOrderIds.length) {
        playOrderNotification();
      }
      lastOrderIds = currentOrderIds;
      allOrders = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
      renderFloors();
      updateBadges().catch(console.error);
    });
    // Sayfa yüklendiğinde
    window.addEventListener('DOMContentLoaded', () => {
      listenMenuRealtime();
      renderFloors();
      updateBadges().catch(console.error);
      loadRatings(); // Puanları da yükle
    });
  </script>
</body>
</html>